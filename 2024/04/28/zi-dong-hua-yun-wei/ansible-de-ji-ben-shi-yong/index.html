<!DOCTYPE HTML>
<html lang="zh-CN">
    

    

<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Ansible的基本使用, Linux技术博客">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style"
        content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Ansible的基本使用 | Linux技术博客</title>
    <link rel="icon" type="image/png"
        href="/favicon.png">

    <link rel="stylesheet" type="text/css"
        href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css"
        href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css"
        href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css"
        href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css"
        href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css"
        href="/css/matery.css">
    <link rel="stylesheet" type="text/css"
        href="/css/my.css">
    <link rel="stylesheet" type="text/css"
        href="/css/loading.css">

    <script
        src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Linux技术博客" type="application/atom+xml">

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


    
    <style>
    body{
       background-image: url(/medias/background.jpg);
       background-repeat:no-repeat;
       background-size:cover;
       background-attachment:fixed;
    }
</style>

    
    <body>
        <div class="stars-con">
            <div id="stars"></div>
            <div id="stars2"></div>
            <div id="stars3"></div>
        </div>
        <svg aria-hidden="true"
            style="position: absolute; overflow: hidden; width: 0; height: 0">
            <symbol id="icon-sun" viewBox="0 0 1024 1024">
                <path
                    d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z"
                    fill="#FFD878" p-id="8420"></path>
                <path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z"
                    fill="#FFE4A9" p-id="8421"></path>
                <path
                    d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z"
                    fill="#4D5152" p-id="8422"></path>
                <path
                    d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z"
                    fill="#4D5152" p-id="8423"></path>
            </symbol>
            <symbol id="icon-moon" viewBox="0 0 1024 1024">
                <path
                    d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z"
                    fill="#FFB531" p-id="11345"></path>
                <path
                    d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z"
                    fill="#030835" p-id="11346"></path>
            </symbol>
        </svg>
        <a onclick="switchNightMode()" class="icon-V hidden" title="切换主题">
            <svg width="48" height="48" viewBox="0 0 1024 1024">
                <use id="modeicon" xlink:href="#icon-moon"></use>
            </svg>
        </a>
        <script>
      function checkNightMode() {
        '1' === localStorage.getItem('isDark') ? ($('body').addClass('DarkMode'), $('#changeMode-top').removeClass('fa-moon').addClass('fa-sun'), $('#modeicon').attr('xlink:href', '#icon-sun')) : '0' === localStorage.getItem('isDark') ? $('#modeicon').attr('xlink:href', '#icon-moon') : new Date().getHours() >= 20 || new Date().getHours() < 7 ? ($('body').addClass('DarkMode'), $('#changeMode-top').removeClass('fa-moon').addClass('fa-sun'), $('#modeicon').attr('xlink:href', '#icon-sun')) : matchMedia('(prefers-color-scheme: dark)').matches ? ($('body').addClass('DarkMode'), $('#changeMode-top').removeClass('fa-moon').addClass('fa-sun'), $('#modeicon').attr('xlink:href', '#icon-sun')) : $('#modeicon').attr('xlink:href', '#icon-moon')
      }
      function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
          setTimeout(function () {
            $('body').hasClass('DarkMode') ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#changeMode-top').removeClass('fa-sun').addClass('fa-moon'), $('#modeicon').attr('xlink:href', '#icon-moon')) : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#changeMode-top').removeClass('fa-moon').addClass('fa-sun'), $('#modeicon').attr('xlink:href', '#icon-sun')),
              setTimeout(function () {
                $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                  $(this).remove()
                })
              }, 2e3)
          })
      }
      function switchNightModeTop() {
        $('body').hasClass('DarkMode') ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#changeMode-top').removeClass('fa-sun').addClass('fa-moon'), $('#modeicon').attr('xlink:href', '#icon-moon')) : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#changeMode-top').removeClass('fa-moon').addClass('fa-sun'), $('#modeicon').attr('xlink:href', '#icon-sun'))
      }
    </script>

        <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Linux技术博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Linux技术博客</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/luovip/tecBlog.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/luovip/tecBlog.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

        



<div class="bg-cover pd-header post-cover" style="background-image: url('/img/ansible-cover.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Ansible的基本使用</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet"
    href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
        background-color: rgb(255, 255, 255,0.7);
        border-radius: 10px;
        box-shadow: 0 10px 35px 2px rgba(0, 0, 0, .15), 0 5px 15px rgba(0, 0, 0, .07), 0 2px 5px -5px rgba(0, 0, 0, .1) !important;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }
    #toc-content .toc-link:hover {
        color: #f40;
        font-weight: 700;
        text-decoration: underline;
    }
    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #f40;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Ansible%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/">
                                <span class="chip bg-color">Ansible的基本使用</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/" class="post-category">
                                自动化运维
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-04-28
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2025-06-01
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    19.9k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    89 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="1-介绍Ansible"><a href="#1-介绍Ansible" class="headerlink" title="1 介绍Ansible"></a>1 介绍Ansible</h1><p>  Ansible是python开发的、开源的批量自动化运维工具</p>
<p>  官方网站：<a target="_blank" rel="noopener" href="https://www.ansible.com、https//docs.ansible.com/">https://www.ansible.com、https://docs.ansible.com/</a></p>
<p><img src="/images/ansible.png"></p>
<h2 id="1-1-Ansible的概念和架构"><a href="#1-1-Ansible的概念和架构" class="headerlink" title="1.1 Ansible的概念和架构"></a>1.1 Ansible的概念和架构</h2><p>  通过inventor定义Managed node，并由SSH与python进行连通：</p>
<p>  1.管理机上管理被管机</p>
<p>  2.inventory(清单)分组被管机</p>
<p>  3.基于SSH、PowerShell进行PUSH ad-hoc或基于YML文件Playbook</p>
<p>  4.Python模块、插件、API</p>
<p><img src="/images/ansible%E6%9E%B6%E6%9E%84.png"></p>
<h2 id="1-2-Absible的优势"><a href="#1-2-Absible的优势" class="headerlink" title="1.2 Absible的优势"></a>1.2 Absible的优势</h2><p>  简单明了：Ansible playbook，更好的对任务进行排序编写</p>
<p>  功能强大：3000多个模块，配置管理、工作流自动化、网络自动化</p>
<p>  无需代理：通过SSH管理，而puppet、saltstack需要装客户端</p>
<p>  与其他系统轻松集成，如jenkins</p>
<p>  跨平台支持：win、linux、unix、网络设备，虚拟机、物理机、云主机、容器</p>
<h2 id="1-3-Ansible自动化平台2"><a href="#1-3-Ansible自动化平台2" class="headerlink" title="1.3 Ansible自动化平台2"></a>1.3 Ansible自动化平台2</h2><p>  1.Ansible自动化平台2-Ansible Core</p>
<p>   包含多个不同的组件，共同提供了一整套集成的自动化工具和资源</p>
<p>   提供用于运行Ansible Playbook的基本功能</p>
<p>   定义了用于在YAML文本文件中编写Ansible Playbook的自动化语言</p>
<p>   提供了自动化代码所需的关键功能，如循环、条件和其他Ansible命令</p>
<p>   提供了驱动自动化所需的框架和基本命令行工具</p>
<p>   在ansible-core RPM软件包及其ee-minimal-rhel8和ee-supported-rhel8自动化执行环境中提供Ansible Core 2.13</p>
<p>  2.Ansible自动化平台2-Ansible内容集合</p>
<p>   在过去，Ansible提供了大量模块作为核心软件包的一部分;这种方法在Ansible社区中被称为“自带电池”</p>
<p>   Ansible中包含的模块数量呈指数级增长。这导致了支持方面的一些挑战，特别是因为用户有时希望使用比Ansible特定版本中附带模块版本更早或更高的模块</p>
<p>   开发人员决定将大多数模块重新整理为单独的Ansible collection(内容集合)，这些资源collection相关的模块角色和插件构成，由同一组开发人员提供支持</p>
<p>   Ansible Core本身仅限于由ansible.builtin、Ansible collection(内容集合)提供的一小组模块，该集合始终是Ansible Core的一部分</p>
<p>   订阅红帽Ansible自动化平台2后，可获得红帽提供的120多个认证内容集合的访问权限，另外还可通过AnsibleGalaxy获得很多受社区支持的集合</p>
<p>  3.Ansible自动化平台2概述-自动化内容导航器</p>
<p>   红帽Ansible自动化平台2还可提供新的顶级工具(自动化内容导航(ansble-navigator))来开发和测试Ansible Playbook。该工具可取代并扩展多个命令行实用程序的功能，包括ansible-playbook、ansible-inventory、ansible-config</p>
<p>   通过在容器中运行playbook，将运行Ansible的控制节点与运行它的自动化执行环境分隔开来。这样一来，可以更轻松地为自动化代码提供完整的工作环境，以部署到生产环境中</p>
<p>  4.Ansible自动化平台2-自动化执行环境</p>
<p>   自动化执行环境是一种容器镜像，包含Ansible Core、Ansible内容集合以及运行playbook所需的任何Python库、可执行文件或其他依赖项</p>
<p>   使用ansible-navigator运行playbook时，可选择用于运行该playbook的自动化执行环境</p>
<p>   当代码运行时，可以向自动化控制器提供playbook和自动化执行环境，并且也知道其具有正确运行playbook所需的一切</p>
<p><img src="/images/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%89%A7%E8%A1%8C%E7%8E%AF%E5%A2%83.png"></p>
<p>  5.Ansible自动化平台2-准备控制节点</p>
<p>   要运行Ansible Playbook，需在控制节点安装自动化内容导航器(ansible-navigator)，然后下载执行环境</p>
<p>   由Ansible托管的主机无需安装ansible-navigator，该工具只需安装在运行Ansible Playbook的控制节点</p>
<p>   安装ansible-core软件包前，先要在控制节点上安装Python3.8或更高版本</p>
<p>   需要有效的红帽Ansible自动化平台订阅，才能在控制节点上安装自动化内容导航器</p>
<p>   如果已在红帽客户门户中为您的组织激活了简单内容访问，则无需再将订阅连接到系统</p>
<h1 id="2-部署Ansible"><a href="#2-部署Ansible" class="headerlink" title="2 部署Ansible"></a>2 部署Ansible</h1><h2 id="2-1-安装Ansible"><a href="#2-1-安装Ansible" class="headerlink" title="2.1 安装Ansible"></a>2.1 安装Ansible</h2><h3 id="2-1-1-安装自动化内容导航器"><a href="#2-1-1-安装自动化内容导航器" class="headerlink" title="2.1.1 安装自动化内容导航器"></a>2.1.1 安装自动化内容导航器</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 登录workstation后默认为student普通用户，根据实际使用和考试结合建议使用普通用户操作
# 方法1:
[kiosk@foundation0 ~]$ ssh student@workstation

# 方法2:
[kiosk@foundation0 ~]$ ssh root@workstation
[root@workstation ~]$ ssh student@localhost

# 控制节点上安装自动化内容导航器    - workstation
[student@workstation ~]$ sudo dnf search ansible   #搜索ansible关键字的软件包，方便查找ansible的软件

[student@workstation ~]$ sudo dnf -y install ansible-navigator.noarch ansible-core.x86_64

[student@workstation ~]$ rpm -q ansible-navigator
ansible-navigator-2.1.0-1.el9ap.noarch

[student@workstation ~]$ rpm -q ansible-core
ansible-core-2.13.0-2.el9ap.x86_64

[student@workstation ~]$ rpm -qc ansible-core
/etc/ansible/ansible.cfg    # 默认全局配置文件
/etc/ansible/hosts          # 默认全局清单文件

[student@workstation ~]$ rpm -qc ansible-navigator<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-1-2-检查Ansible版本"><a href="#2-1-2-检查Ansible版本" class="headerlink" title="2.1.2 检查Ansible版本"></a>2.1.2 检查Ansible版本</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 检查ansible的版本
[student@workstation ~]$ ansible --version
ansible [core 2.13.0]
  config file = /etc/ansible/ansible.cfg
...

[student@workstation ~]$ ansible-navigator --version
ansible-navigator 2.1.0

# 安装ansible后会提供导航器配置文件
[student@workstation ~]$ ls -a
.   .ansible               .ansible-navigator.yml  .bash_logout   .bashrc  .config  Documents  .grading  .jupyter  Music  Pictures  .ssh       .venv
..  ansible-navigator.log  .bash_history           .bash_profile  .cache   Desktop  Downloads  .ipython  .local    .npm   Public    Templates  Videos
[student@workstation ~]$ cat .ansible-navigator.yml
---
ansible-navigator:
  execution-environment:
    image: utility.lab.example.com/ee-supported-rhel8:latest
    pull:
      policy: missing<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-1-3-登录镜像仓库"><a href="#2-1-3-登录镜像仓库" class="headerlink" title="2.1.3 登录镜像仓库"></a>2.1.3 登录镜像仓库</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 配置镜像仓库不进行https验证
[student@workstation ~]$ mkdir ~/.config/containers 

# ~/.config/containers等价于/home/student/.config/containers
[student@workstation ~]$ cp /etc/containers/registries.conf ~/.config/containers
[student@workstation ~]$ vim ~/.config/containers/registries.conf
unqualified-search-registries = ["utility.lab.example.com"]  # 22行
[[registry]]  # 24行
insecure = true  # 37行
blocked = false   # 40行
location = "utility.lab.example.com"  # 56行

# 登录容器镜像服务器，为下载自动化执行环境容器镜像做准备
[student@workstation ~]$ podman --version
podman version 4.0.2

[student@workstation ~]$ podman login -u admin -p redhat utility.lab.example.com
Login Succeeded!

# 下载自动化内容导航器或使用ansible-navigator命令自动下载
[student@workstation ~]$ ansible-navigator collections    

[student@workstation ~]$ ansible-navigator images   # 查看下载的镜像环境<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-2-构建Ansible清单"><a href="#2-2-构建Ansible清单" class="headerlink" title="2.2 构建Ansible清单"></a>2.2 构建Ansible清单</h2><h3 id="2-2-1-默认的清单文件"><a href="#2-2-1-默认的清单文件" class="headerlink" title="2.2.1 默认的清单文件"></a>2.2.1 默认的清单文件</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 清单定义Ansible管理的主机集合。主机可以分配到组中进行集中管理。组可以包含子组，主机也可以是多个组的成员
# 清单还可以设置应用到它所定义的主机和组的变量
# 定义主机清单可采用两种方式:
  1.使用文本文件定义静态主机清单
  2.通过外部信息提供程序，使用Ansible插件按需生成动态主机清单
# 系统默认清单在/etc/ansibile/hosts

# 举例:
# [嵌套组名:children]，嵌套组内只能包含组，不包含主机
[test]
servera

[web]
serverb.example.com

[webservers]
web[1:50].example.com   # 表示从web1到web50，共计50台主机

[servers:children]  # 表示servers组是一个超级组，包含test和web两个组(嵌套)
test
web
webservers

# 指定清单范围格式：通配符或正则表达式的方法
[START:END]                  #开始:结束范围
192.168.[0:15].[0:255]       #表示   192.168.0.0-192.168.15.255
server[a:c].example.com      #表示   a-c
server[01:15].example.com    #表示   server01.example.com-server15.example.com
all：                        #表示   所有主机
ungrouped:                   #表示   指定组/未分配组的主机      <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-2-2-自定义清单文件"><a href="#2-2-2-自定义清单文件" class="headerlink" title="2.2.2 自定义清单文件"></a>2.2.2 自定义清单文件</h3><p>  1.创建工作目录</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 当使用特权用户管理Ansible时，可以在家目录中为其创建工作目录
# 目录名称可以根据业务自定义名称,后续的所有文件都放到此目录，包括配置文件、清单文件、playbook等
[student@workstation ~]$ mkdir ~/ansible
[student@workstation ~]$ cd ~/ansible/
[student@workstation ansible]$ pwd
/home/student/ansible

# 查看清单实例文件
[student@workstation ansible]$ ansible-doc -t inventory -l
[student@workstation ansible]$ ansible-doc -t inventory ini
[student@workstation ~]$ ansible-navigator doc -t inventory ini<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  2.编辑自定义清单文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ansible]$ vim inventory
servera                    # 未在组内的主机

[web]                      # 主机组，主机组名称需要使用中括号括起来[]，web是组名称
server[b:c]                # 主机组成员，web组内的主机 表示两个主机serverb至serverc
172.25.250:[10:15]

[db]
server[d:z].lab.example.com

# 嵌套组名servers是自定义的，:children是固定语法，表示web、db在servers组中，嵌套组成员应为组，不应为主机
[servers:children]  
web
db
# 不要在清单里书写无用的符号，及一些特殊符号。主机名称不要和主机组冲突，组名尽量不要用数字开头<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  3.验证清单</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 使用ansible-navigator或ansible-inventory命令验证计算机是否存在于清单中
  1.ansible-navigator inventory以stdout模式运行
  2.第一条传统Ansible的验证方式，第二条使用Ansible自动化平台2的方式
-RHEL8 &amp; 9
-i inventory  # 指定清单文件的位置
--list-hosts  # 列出清单中的主机  
--graph       # 通过ansible-inventory命令列出清单整个pattern

$ ansible all -i inventory --list-hosts
$ ansible-inventory --graph -i inventory  
[student@workstation ansible]$ ansible-inventory --graph -i /home/student/ansible/inventory

-RHEL 9
$ ansible-navigator inventory -i inventory  -m stdout --list
$ ansible-navigator inventory -i inventory  -m stdout --graph
$ ansible-navigator inventory -i inventory  -m stdout --graph webservers

重要：清单中含有名称相同的主机和主机组，ansible命令显示警告并以主机作为其目标，组被忽略<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-2-3-覆盖清单位置"><a href="#2-2-3-覆盖清单位置" class="headerlink" title="2.2.3 覆盖清单位置"></a>2.2.3 覆盖清单位置</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 安装ansible软件后，在/etc/ansible/hosts位置提供一个默认主机清单，属于全局管理范围
# 特权用户管理时可以为其在工作目录中创建清单，在工作目录中使用ansible时，且优先度最高
/home/student/ansible/inventory   # 用于针对某个用户设置清单
/etc/ansible/hosts                  # 用于全局设置
[student@workstation /]$ ansible-inventory --graph
@all:
  |--@ungrouped:
[student@workstation /]$ pwd
/
[student@workstation ansible]$ ansible-inventory --graph
@all:
  |--@ungrouped:
[student@workstation ansible]$ pwd
/home/student/ansible<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-2-4-多清单"><a href="#2-2-4-多清单" class="headerlink" title="2.2.4 多清单"></a>2.2.4 多清单</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 一个用户可以有一个或多个清单文件，若同时使用，可将多个清单文件放置在清单目录中，清单目录需自行创建，名称自定义
[student@workstation ansible]$ vim inventory
servera

[web]
serverb
serverc

[db]
serverd

[servers:children]
web
db
[student@workstation ansible]$ ansible-inventory --graph -i inventory

[student@workstation ansible]$ cp inventory inventory2       #额外创建一份清单名为inventory2
# [student@workstation ansible]$ echo servere &gt; inventory2   #inventory2内指定一个主机servere
[student@workstation ansible]$ vim inventory2                
servere

[student@workstation ansible]$ mkdir invdir                   #创建清单存储目录，名称自定义
[student@workstation ansible]$ mv inv* invdir/                #将所有清单移动至清单存储目录
mv: cannot move 'invdir' to a subdirectory of itself, 'invdir/invdir'
[student@workstation ansible]$ ls invdir/
inventory  inventory2

[student@workstation ansible]$ ansible-inventory --graph -i invdir/  #查看主机模式结构<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-3-管理Ansible配置文件"><a href="#2-3-管理Ansible配置文件" class="headerlink" title="2.3 管理Ansible配置文件"></a>2.3 管理Ansible配置文件</h2><h3 id="2-3-1-配置Ansible"><a href="#2-3-1-配置Ansible" class="headerlink" title="2.3.1 配置Ansible"></a>2.3.1 配置Ansible</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 安装Ansible软件后，自动生成配置文件
   /etc/ansible/ansible.cfg  用于配置多个Ansible工具的行为
   ~/.ansible-navigator.yml  用于更改ansible-navigator命令默认选项
[student@workstation ansible]$ rpm -qc ansible-core
/etc/ansible/ansible.cfg
/etc/ansible/hosts
[student@workstation ~]$ ls -a
.         ansible                 .bash_history  .bashrc  Desktop    .grading  .lesshst  .npm      .ssh       Videos
..        ansible-navigator.log   .bash_logout   .cache   Documents  .ipython  .local    Pictures  Templates  .viminfo
.ansible  .ansible-navigator.yml  .bash_profile  .config  Downloads  .jupyter  Music     Public    .venv
[student@workstation ~]$ ls -a ~/.ansible-navigator.yml
/home/student/.ansible-navigator.yml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-3-2-管理Ansible设置"><a href="#2-3-2-管理Ansible设置" class="headerlink" title="2.3.2 管理Ansible设置"></a>2.3.2 管理Ansible设置</h3><table>
<thead>
<tr>
<th align="left">指令</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">inventory</td>
<td align="left">指定清单文件的路径。</td>
</tr>
<tr>
<td align="left">remote_user</td>
<td align="left">指定Ansible用于连接受管主机的用户名。如果未指定，则使用当前用户的名称。(在由ansible-navigator 运行的基于容器的自动化执行环境中，始终为 root。)</td>
</tr>
<tr>
<td align="left">ask_pass</td>
<td align="left">指示是否提示输入SSH 密码。 (可以是 false，如果使用SSH公钥身份验证，则此为默认值。)</td>
</tr>
<tr>
<td align="left">become</td>
<td align="left">指定连接后是否在受管主机上自动切换用户(一般切换为root)。这也可以通过play来指定</td>
</tr>
<tr>
<td align="left">become_method</td>
<td align="left">指定如何切换用户(通常为 sudo，此为默认值，但也可选择su)</td>
</tr>
<tr>
<td align="left">become_user</td>
<td align="left">指定要在受管主机上切换到哪个用户(通常为 root，此为默认值)</td>
</tr>
<tr>
<td align="left">become_ask_pass</td>
<td align="left">指示是否提示输入become_method参数密码。默认为false</td>
</tr>
</tbody></table>
<h3 id="2-3-3-管理配置文件"><a href="#2-3-3-管理配置文件" class="headerlink" title="2.3.3 管理配置文件"></a>2.3.3 管理配置文件</h3><p>  1.自定义配置文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 在工作目录中生成ansible的配置文件
[student@workstation ~]$ cat /etc/ansible/ansible.cfg | grep ansible.cfg
#               $ ansible-config init --disabled &gt; ansible.cfg
...

[student@workstation ~]$ ansible-config init --disabled &gt; /home/student/ansible/ansible.cfg

[student@workstation ~]$ cd /home/student/ansible/
[student@workstation ansible]$ ls
ansible.cfg  inventory
 
[student@workstation ansible]$ ansible --version
ansible [core 2.13.0]
  config file = /home/student/ansible/ansible.cfg

# Ansible的配置文件(ansible.cfg)由几部分组成，含有以键值对形式定义的设置、标题以方括号括起
# 对于基本操作，使用以下两部分:
1.[defaults]---用于设置Ansible操作的默认值
2.[privilege_escalation]---用于配置Ansible如何在受管主机上执行特权升级
    
[student@workstation ansible]$ vim ansible.cfg
[defaults]
inventory=/home/student/ansible/inventory    #139行  工作目录清单位置
remote_user=student                             #222行  远程用户可选root或普通用户 
host_key_checking=false                         #318行  不进行公钥记录

[privilege_escalation]                        #搜/become，n向下查找 或 输入:430
become=true                                    #430行  开启特权功能，
#become_ask_pass=False                        #433行  远程免特权密码，需要对端添加sudo免密	
#become_method=sudo                            #442行  远程功能启用sudo
#become_user=root                            #445行  特权用户为root

备注:剪切操作 dd+p
# 验证配置文件是否书写正确
[student@workstation ansible]$ ansible-inventory --graph   # 取消对清单的指定
  
#为servera~d主机设置sudo免密。
[workstation]
[student@workstation ansible]$ for i in {a..d};do ssh root@server$i 'sed -i s/^%wheel.*$/"%wheel  ALL=(ALL) NOPASSWD: ALL"/ /etc/sudoers';done
[student@workstation ansible]$ for i in {a..d};do ssh root@server$i 'grep ^%wheel /etc/sudoers';done

# 测试远程部署
[student@workstation ansible]$ ansible all -m ping
serverd | SUCCESS =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python3"
    },
    "changed": false,
    "ping": "pong"
}
...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  2.配置文件的优先级</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ /etc/ansible/ansible.cfg           #默认路径
$ ~/.ansible.cfg                       #家目录
$ ~/ansible/ansible.cfg              #ansible为工作目录(练习和考试时使用)
$ grep  ANSIBLE_CONFIG /etc/profile  #环境变量
export  ANSIBLE_CONFIG=/opt/ansible.cfg   （此时/opt下需要有ansible.cfg配置文件）
source /etc/profile   加载

# 优先级 ：变量＞当前目录＞用户家目录＞/etc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  3.指定远程用户</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 其他指定远程用户及密码的方法
# 方法1：
ansible.cfg
remote_user=root
inventory
[all:vars]
ansible_password=redhat

# 方法二：
inventory
[all:vars]
ansible_user=root
ansible_password=redhat<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-3-4-管理自动化内容导航器"><a href="#2-3-4-管理自动化内容导航器" class="headerlink" title="2.3.4 管理自动化内容导航器"></a>2.3.4 管理自动化内容导航器</h3><p>  1.创建自动化内容导航器</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#可以为ansible-navigator创建配置文件以覆盖其配置设置的默认值，采用JSON(json)或YAML(yml或yam)格式

#自动化内容导航器按以下顺序查找配置文件，并使用它找到的第一个文件:
1.如果设置了ANSIBLE NAVIGATOR_CONFIG环境变量，则使用所指定位置处的配置文件
2.当前Ansible项目目录中的ansible-navigator.yml文件
3.~/.ansible-navigator.yml文件(主目录中)。请注意，其文件名开头有一个“点”

#与Ansible配置文件一样，每个项目都可以有自己的自动化内容导航器设置文件 

#创建导航器配置文件
[student@workstation ~]$ rpm -ql ansible-navigator | grep temp
[student@workstation ~]$ vim /usr/lib/python3.9/site-packages/ansible_navigator/package_data/settings-sample.template.yml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  2.配置自动化内容导航器</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ~]$ vim ~/.ansible-navigator.yml
---
ansible-navigator:
  execution-environment:
    image: utility.lab.example.com/ee-supported-rhel8:latest
    pull:
      policy: missing    # 容器镜像下载策略 missing系统里有就不下载，否则下载

$ vim ~/.ansible-navigator.yml 
  ---
ansible-navigator:
  execution-environment:
    image: utility.lab.example.com/ee-supported-rhel8:latest
    pull:
      arguments:
      - "--tls-verify=false"
      policy: missing
  playbook-artifact:
    enable: false   #关闭运行playbook时生成日志 执行剧本所产生的日志，执行一次记录一次<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-3-5-ansible的远程连接"><a href="#2-3-5-ansible的远程连接" class="headerlink" title="2.3.5 ansible的远程连接"></a>2.3.5 ansible的远程连接</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#anisble远程连接时的必要条件
1.配置链接：如何选择远程的用户
2.清单位置：相对路径、绝对路径、多清单等。
3.链接设置: remote_user= ，~/.ansible-navigator.yml中playbook-artifact：
4.ssh免密:  ssh-key-gen，ssh-copy-id
5.升级特权: visudo，/etc/sudoers<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="3-编写和运行Playbook"><a href="#3-编写和运行Playbook" class="headerlink" title="3 编写和运行Playbook"></a>3 编写和运行Playbook</h1><p>  Play是针对清单中选定的主机运行的一组有序任务</p>
<p>  Playbook是一个文本文件，其中包含由一个或多个按特定顺序运行的play组成的列表</p>
<p>  临时命令可以作为一次性命令对一组目标主机运行一项简单的任务</p>
<p>  Playbook可以通过轻松重复的方式对一组目标主机执行多项复杂的任务</p>
<p><img src="/images/Playbook.png"></p>
<h2 id="3-1-Playbook-yaml语法"><a href="#3-1-Playbook-yaml语法" class="headerlink" title="3.1 Playbook-yaml语法"></a>3.1 Playbook-yaml语法</h2><p>  1.playbook是使用YAML语法编写的文本文件，格式为.yml</p>
<p>  2.严格缩进，空格</p>
<p>  3.YAML文件以—开头，…. 结束，可以省略</p>
<p>  4.使用”-“(减号加一个或多个空格)作为列表项</p>
<p>  5.#注释</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ ansible-doc -l | grep yum
$ ansible-doc yum                       #进入之后，搜索/EXAMPLE
$ vim ~/ansible/web.yml
---                                     #yaml语法，---开头
- name: install httpd                   #play任务的描述：描述部分name字段是可选的选项
  hosts: servera                        #主机模式：任务目标主机
  tasks:                                #任务列表：下面通常为任务模块，有两格缩进
  - name: Install Apache                #任务模块：注意和tasks有两格缩进，name是可选字段，模块描述
    ansible.builtin.yum:                #模块名称：
      name: httpd                       #模块选项1
      state: latest                     #模块选项2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-2-关闭运行playbook时的日志"><a href="#3-2-关闭运行playbook时的日志" class="headerlink" title="3.2 关闭运行playbook时的日志"></a>3.2 关闭运行playbook时的日志</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ansible]$ vim ~/.ansible-navigator.yml
---
ansible-navigator:
  execution-environment:
    image: utility.lab.example.com/ee-supported-rhel8:latest
    pull:
      policy: missing
  playbook-artifact:
    enable: false  #关闭playbook时生成的日志<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-3-调整tab键缩进"><a href="#3-3-调整tab键缩进" class="headerlink" title="3.3 调整tab键缩进"></a>3.3 调整tab键缩进</h2><p><img src="/images/%E5%89%A7%E6%9C%AC%E7%BC%A9%E8%BF%9B.png"></p>
<p>整体缩进–方便对齐yaml语法文本缩进</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">vim ~/.vimrc
set tabstop=2    #将vim的tab键缩进调至两格
set nu             #设置行号
set autoindent   #回车时调整至上一行文本缩进  
set cursorcolumn #设置竖坐标线 简写set cuc
set cursorline   #设置横坐标线 简写set cul

:set all        #末行模式下set all 查看所有环境设置帮助

#整体缩进 视图模式
ctrl+v ， jjj(+G) ，I，(空格、空格)，esc

#分解：
1.光标放在需要调节的行上
2.按ctrl+v，用方向键或G选定需要调节的列
3.输入I进入插入模式
4.空格空格，调节需要的缩进
5.按esc同步所有列<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-4-查找用于任务的模块"><a href="#3-4-查找用于任务的模块" class="headerlink" title="3.4 查找用于任务的模块"></a>3.4 查找用于任务的模块</h2><p>  用Ansible进行部署任务时，可针对管理员任务需求，选择对应功能模块，通过以下方法可以查询模块帮助，以便编写临时命令及playbook</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">-RHEL&lt;=8
[student@workstation ansible]$ ansible-doc -l
[student@workstation ansible]$ ansible-doc -l | grep yum
yum                                            Manages packages with the `y...
yum_repository                                 Add or remove YUM repositori...

# 查看某个模块的帮助
[student@workstation ansible]$ ansible-doc yum

-RHEL=9
$ ansible-navigator collections
$ ansible-navigator doc ansible.posix.firewalld
$ ansible-navigator doc ansible.posix.firewalld -m stdout

[student@workstation ansible]$ ansible-navigator collections -m stdout | grep firewalld<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-5-运行Playbook"><a href="#3-5-运行Playbook" class="headerlink" title="3.5 运行Playbook"></a>3.5 运行Playbook</h2><p>  运行前检查语法错误或执行空运行：</p>
<p>   1.检查语法错误 ansible-navigator run web.yml –syntax-check file.yml</p>
<p>   2.执行空运行 ansible-navigator run web.yml -C</p>
<p>  通常直接运行ansible-navigator run web.yml进入交互模式或添加-m stdout可将任务打印到标准输出</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#运行playbook
$ ansible-navigator run web.yml    # 交互式
$ ansible-navigator run web.yml -m stdout  # 非交互式<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="3-6-实施多个Play"><a href="#3-6-实施多个Play" class="headerlink" title="3.6 实施多个Play"></a>3.6 实施多个Play</h2><p>  1.Playbook是一个YAML文件，含有由一个或多个play组成的列表</p>
<p>  2.如果一个playbook中含有多个 play，每个play可以将其任务应用到单独的一组主机</p>
<p>  3.编排涉及对不同主机执行不同任务的复杂部署时会大有帮助</p>
<p>  4.可以这样编写playbook：对一组主机运行一个play，完成后再对另一组主机运行另一个pla</p>
<p>  5.Playbook中的各个play编写为playbook中的顶级列表项</p>
<h3 id="3-6-1-编写多个Play"><a href="#3-6-1-编写多个Play" class="headerlink" title="3.6.1 编写多个Play"></a>3.6.1 编写多个Play</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ansible]$ vim install_yum.yml
---
- name: install yum repo
  hosts: servera,serverb
  - name: AppStream_REPO
    ansible.builtin.yum_repository:
      name: Red Hat Enterprise Linux 9 for x86_64 - AppStream (RPMs)
      description: AppStream
      file: rhel_AppStream
      baseurl: http://content.example.com/rhel9.0/x86_64/dvd/AppStream
      gpgcheck: no

- name: install yum repo
  hosts: serverc
  tasks:
  - name: BaseOS_REPO
    ansible.builtin.yum_repository:
      name: Red Hat Enterprise Linux 9 for x86_64 - BaseOS (RPMs)
      description: BaseOS
      file: rhel_BaseOS
      baseurl: http://content.example.com/rhel9.0/x86_64/dvd/BaseOS
      gpgcheck: no      
      
#ansible-navigator collections,ansible-navigator doc  ansible.posix.firewalld -m stdout
[student@workstation ansible]$ ansible-navigator collections -m stdout | grep firewalld
[student@workstation ansible]$ ansible-navigator doc ansible.posix.firewalld -m stdout

--syntax-check  
[student@workstation ansible]$ ansible-navigator run install_yum.yml -m stdout --syntax-check
playbook: /home/student/ansible/install_yum.yml

-v -vv -vvv
[student@workstation ansible]$ ansible-navigator run install_yum.yml -m stdout --syntax-check -v


[student@workstation ansible]$ ansible-navigator run install_yum.yml -m stdout

# 测试运行剧本后的结果
[student@workstation ansible]$ ansible -m shell all -a 'yun -y install ftp'
[student@workstation ansible]$ ansible all -m shell -a 'rpm -q ftp'

# 用ansible-doc查询所有模块
yum        安装软件
service    管理服务
shell模块  管理防火墙
copy       拷贝，1有拷贝功能，2 可以将一段文本，复制到某个文件中，如文件不存在，则生成文件。
uri        网站连接测试<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-6-2-选择模块"><a href="#3-6-2-选择模块" class="headerlink" title="3.6.2 选择模块"></a>3.6.2 选择模块</h3><table>
<thead>
<tr>
<th align="left">类别</th>
<th align="left">模块</th>
</tr>
</thead>
<tbody><tr>
<td align="left">文件</td>
<td align="left">ansible.builtin.copy: 将本地文件复制到受管主机 ansible.builtin.file: 设置文件的权限和其他属性 ansible.builtin.lineinfile: 确保特定行是否在文件中 ansible.posix.synchronize: 使用rsync 同步内容</td>
</tr>
<tr>
<td align="left">软件</td>
<td align="left">ansible.builtin.package: 使用操作系统自带的自动检测软件包管理器管理软件包。 ansible.builtin.dnf: 使用DNF软件包管理器管理软件包 ansible.builtin.apt: 使用APT 软件包管理器管理软件包 ansible.builtin.pip: 从PyPI管理Python 软件包。</td>
</tr>
<tr>
<td align="left">系统</td>
<td align="left">ansible.posix.firewalld: 使用firewalld 管理任意端口和服务 ansible.builtin.reboot: 重新启动计算机。 ansible.builtin.service: 管理服务 ansible.builtin.user: 添加、删除和管理用户帐户</td>
</tr>
<tr>
<td align="left">网络工具</td>
<td align="left">ansible.builtin.get_url: 通过HTTP、HTTPS或FTP 下载文件 ansible.builtin.uri: 与Web 服务交互</td>
</tr>
</tbody></table>
<h1 id="4-管理变量"><a href="#4-管理变量" class="headerlink" title="4 管理变量"></a>4 管理变量</h1><h2 id="4-1-变量概述"><a href="#4-1-变量概述" class="headerlink" title="4.1 变量概述"></a>4.1 变量概述</h2><h3 id="4-1-1-Ansible变量简介"><a href="#4-1-1-Ansible变量简介" class="headerlink" title="4.1.1 Ansible变量简介"></a>4.1.1 Ansible变量简介</h3><p>  Ansible支持利用变量来存储值，并在Ansible项目的所有文件中重复使用这些值</p>
<p>  可以简化项目的创建和维护，并减少错误的数量</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># key：vaule  
# 变量可以重复的应用到项目中，简化管理，应用对象可以是：
1.要创建的用户
2.要安装的软件包
3.要重新启动的服务
4.要删除的文件
5.互联网的文档等<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-1-2-命名变量"><a href="#4-1-2-命名变量" class="headerlink" title="4.1.2 命名变量"></a>4.1.2 命名变量</h3><p>  变量名称必须以字母开头，并且只能含有字母、数字和下划线</p>
<table>
<thead>
<tr>
<th align="left">无效变量名称</th>
<th align="left">有效变量名称</th>
</tr>
</thead>
<tbody><tr>
<td align="left">web server</td>
<td align="left">web_server</td>
</tr>
<tr>
<td align="left">remote.file</td>
<td align="left">remote_file</td>
</tr>
<tr>
<td align="left">1st file</td>
<td align="left">file_1，file1</td>
</tr>
<tr>
<td align="left">remoteserver $1</td>
<td align="left">remote_server_1,remote_server1</td>
</tr>
</tbody></table>
<h2 id="4-2-定义变量"><a href="#4-2-定义变量" class="headerlink" title="4.2 定义变量"></a>4.2 定义变量</h2><p>  可在Ansible项目中的多个位置定义变量</p>
<p>  如果在两个位置设置了同名变量，并且变量值不同，则通过优先级来决定要使用哪个值</p>
<p>  可以设置会影响一组主机的变量，也可以设置只会影响个别主机的变量</p>
<p>  有些变量是Ansible可以根据系统配置来设置的事实</p>
<p>  有些变量可在playbook中设置，然后影响该playbook中的一个play，或者仅影响该play中的一项任务</p>
<p>  可通过–extra-vars或-e选项并指定变量值</p>
<p>  Ansible的变量可以定义在不同位置，根据需要设定，其中也有优先度</p>
<table>
<thead>
<tr>
<th align="left">应用场景</th>
<th align="left">描述</th>
<th align="left">优先度</th>
</tr>
</thead>
<tbody><tr>
<td align="left">全局范围</td>
<td align="left">命令行执行临时命令时指定的变量 -e key=vaule</td>
<td align="left">高</td>
</tr>
<tr>
<td align="left">play范围</td>
<td align="left">playbook的Play部分或模块内部指定变量信息key: vaule</td>
<td align="left">中</td>
</tr>
<tr>
<td align="left">主机范围</td>
<td align="left">清单中主机或主机组指定变量（主机 优先 主机组）</td>
<td align="left">低</td>
</tr>
</tbody></table>
<h3 id="4-2-1-全局范围-命令行"><a href="#4-2-1-全局范围-命令行" class="headerlink" title="4.2.1 全局范围-命令行"></a>4.2.1 全局范围-命令行</h3><p>  清单变量可被playbook中设置的变量覆盖，这两种变量又可通过在命令行中传递参数到ansible-navigatorrun 命令来覆盖</p>
<p>  在命令行上设置的变量称为额外变量</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#命令行使用变量优先级最高
[student@workstation ansible]$ ansible servera -m shell -a whoami -e ansible_user=root -e ansible_password=redhat
servera | CHANGED | rc=0 &gt;&gt;
root

#在执行playbook时指定变量
[student@workstation ansible]$ ansible-navigator run install_yum.yml -m stdout -e ansible_user=root -e ansible_password=redhat<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-2-2-PlAY范围-Playbook"><a href="#4-2-2-PlAY范围-Playbook" class="headerlink" title="4.2.2 PlAY范围-Playbook"></a>4.2.2 PlAY范围-Playbook</h3><p>  变量在Ansible Playbook中发挥着重要作用，可以简化playbook中变量数据的管理</p>
<p>  编写play时，可以定义自己的变量，然后在任务中调用这些值</p>
<p>  例如，可以使用值httpd来定义名为web_package的变量，任务可以使用ansible.builtin.dnf模块调用该变量来安装httpd软件包</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#playbook中可以在play位置使用vars直接定义变量，也可以通过vars_files加载包含变量的文件。
#1.在playbook的play部分使用vars直接定义变量
-vars
[student@workstation ansible]$ vim web.yml
---
- name: PLAY1
  hosts: servera
  vars:               		 #vars关键字就是在playbook中设置自定义变量
  - package: httpd             #key：vaule    键值间：冒号隔开，冒号后有一个空格
  tasks:
  - name: install {{ package }}
    ansible.builtin.yum:
      name: "{{ package }}" #使用变量时，变量两边有空格，并且用双大括号括起来，变量开头要加“”双引号，非变量开头不用加双引号
      state: latest   
      
[student@workstation ansible]$ ansible-navigator run web.yml -m stdout --syntax-check
playbook: /home/student/ansible/web.yml

[student@workstation ansible]$ ansible-navigator run web.yml -m stdout


#2.生成变量文件
-vars_files  
[student@workstation ansible]$ vim /home/student/ansible/var.yml   
---
package: httpd   #定义变量

[student@workstation ansible]$ vim /home/student/ansible/httpd.yml
---
- name: PLAY2
  hosts: serverb
  vars_files:
  - /home/student/ansible/var.yml    #vars_files 加载变量文件到剧本中
  tasks:
  - name: install {{ package }}
    ansible.builtin.yum:
      name: "{{ package }}"
      state: latest
      
[student@workstation ansible]$ ansible-navigator run httpd.yml -m stdout --syntax-check
playbook: /home/student/ansible/httpd.yml

[student@workstation ansible]$ ansible-navigator run httpd.yml -m stdout<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-2-3-主机范围-清单中"><a href="#4-2-3-主机范围-清单中" class="headerlink" title="4.2.3 主机范围-清单中"></a>4.2.3 主机范围-清单中</h3><p>  直接应用于主机的清单变量分为两大类：</p>
<p>   1.主机变量：应用于特定主机</p>
<p>   2.组变量：应用于一个主机组或组主机组中的所有主机。</p>
<p>  主机变量优先于组变量，但playbook中定义的变量的优先级比这两者更高</p>
<p>  若要定义主机变量和组变量，一种方法是直接在清单文件中定义</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ansible]$ vim /home/student/ansible/inventory
172.25.250.9   ansible_password=redhat     #给主机定义变量

[test]
172.25.250.10 

[test:vars]               #主机组变量中vars是固定语法
ansible_password=redhat   #给主机组定义变量   

[prod]
172.25.250.[11:12]

[balancers]
172.25.250.13

[all:vars]   #给所有主机和主机组组定义变量
ansible_user=root
ansible_password=redhat <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-2-4-目录填充主机和组变量"><a href="#4-2-4-目录填充主机和组变量" class="headerlink" title="4.2.4 目录填充主机和组变量"></a>4.2.4 目录填充主机和组变量</h3><p>  定义主机和主机组变量的首选做法是在清单文件或目录相同的工作目录中创建group_vars和host_vars两个目录，这两个目录分别包含用于定义组变量和主机变量文件</p>
<p>  建议在host_vars和group_vars目录定义清单变量，而不是直接在清单文件中定义它们</p>
<p><img src="/images/%E7%9B%AE%E5%BD%95%E5%A1%AB%E5%85%85%E4%B8%BB%E6%9C%BA%E5%92%8C%E7%BB%84%E5%8F%98%E9%87%8F.png"></p>
<h2 id="4-3-字典形式表示变量"><a href="#4-3-字典形式表示变量" class="headerlink" title="4.3 字典形式表示变量"></a>4.3 字典形式表示变量</h2><p>  除了将与同一元素相关的配置数据分配到多个变量外，管理员也可以使用字典</p>
<p>  字典是一个包含键值对的数据结构，其中的值也可以是字典</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">vim vari.yml
---
users:
  user1:
    A_name: zhang
    B_name: san
    C_name: /home/zhangsan
  user2:
    A_name: li
    B_name: si
    C_name: /home/lisi <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-4-调用变量"><a href="#4-4-调用变量" class="headerlink" title="4.4 调用变量"></a>4.4 调用变量</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#方法1：
  users.user1.A_name
  users.user2.B_name

#方法2：
  应用方法2：python字典
  users['user1']['A_name']
   
# [student@bastion ansible]$ vim user.yml
---
- name: useradd
  hosts: dev
  vars_files:
  - vari.yml
  tasks:
  - name: Add the user
    ansible.builtin.user:
      name: "{{ users.user1.A_name }}{{ users.user1.B_name }}"
      home: "{{ users['user1']['C_name'] }}"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-5-已注册变量捕获命令输出"><a href="#4-5-已注册变量捕获命令输出" class="headerlink" title="4.5 已注册变量捕获命令输出"></a>4.5 已注册变量捕获命令输出</h2><p>  register用来捕获命令输出或有关模块执行的其他信息，输出会保存至一个变量中</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ vim register.yml
---
- name: install a packages
  hosts: servera
  tasks:
  - name: install the latest version of Apache
    ansible.builtin.yum:
      name: httpd
      state: latest
    register: install_result  #register字段负责收集变量 install_result自定义变量名被收集变量名
  - name:  message
    ansible.builtin.debug:            
      var: install_result     #debug模块var选项打印register获取install_result变量值

#验证
$ ansible-navigator run -m stdout register.yml <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="5-管理机密-vault"><a href="#5-管理机密-vault" class="headerlink" title="5 管理机密-vault"></a>5 管理机密-vault</h1><h2 id="5-1-介绍Ansible-vault"><a href="#5-1-介绍Ansible-vault" class="headerlink" title="5.1 介绍Ansible-vault"></a>5.1 介绍Ansible-vault</h2><p>  Ansible可能需要访问密码或API密钥等敏感数据，以配置受管主机</p>
<p>  通常信息会以纯文本形式存储在清单变量或其他Ansible文件中。但若如此，任何有权访问Ansible文件的用户或存储这些Ansible文件的版本控制系统都能够访问此敏感数据，这显然存在安全风险</p>
<p>  使用Ansible的Ansible Vault可以加密和解密任何由Ansible使用的数据文件</p>
<p>  可通过一个名为ansible-vault的命令行工具创建、编辑、加密、解密和查看文件</p>
<p>  Ansible Vault可以加密任何由Ansible使用的数据文件，这可能包括清单变量、playbook中含有的变量文件、在执行playbook时作为参数传递的变量文件或者Ansible角色中定义的变量</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ~]$ ansible-vault --help
usage: ansible-vault [-h] [--version] [-v] {create,decrypt,edit,view,encrypt,encrypt_string,rekey} ...
encryption/decryption utility for Ansible data files
positional arguments:
  {create,decrypt,edit,view,encrypt,encrypt_string,rekey}
    create              Create new vault encrypted file     #创建密码文件
    decrypt             Decrypt vault encrypted file        #解密现有密码文件
    edit                Edit vault encrypted file           #编辑现有密码文件
    view                View vault encrypted file           #查看加密文件
    encrypt             Encrypt YAML file                   #加密现有文件
    encrypt_string      Encrypt a string
    rekey               Re-key a vault encrypted file       #更改加密文件的密码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-2-创建与查看加密文件"><a href="#5-2-创建与查看加密文件" class="headerlink" title="5.2 创建与查看加密文件"></a>5.2 创建与查看加密文件</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#创建加密文件-create
[student@workstation ansible]$ ansible-vault create sec1.txt   #默认sec1.txt不存在，通过该命令生成
New Vault password: redhat
Confirm New Vault password: redhat

[student@workstation ansible]$ cat sec1.txt

#查看加密文件-view
[student@workstation ansible]$ ansible-vault view sec1.txt
Vault password: redhat
---
This is a encrypted file!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-3-编辑现有的加密文件"><a href="#5-3-编辑现有的加密文件" class="headerlink" title="5.3 编辑现有的加密文件"></a>5.3 编辑现有的加密文件</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#编辑加密文件-edit
[student@workstation ansible]$ pwd
/home/student/ansible

[student@workstation ansible]$ ansible-vault edit sec1.txt
Vault password:
[student@workstation ansible]$ ansible-vault view sec1.txt
Vault password:
---
This is a encrypted file!
password: redhat321<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-4-加密现有的文件"><a href="#5-4-加密现有的文件" class="headerlink" title="5.4 加密现有的文件"></a>5.4 加密现有的文件</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ansible]$ echo China &gt; sec2.txt   #创建文件
[student@workstation ansible]$ cat sec2.txt       
China

#加密现有文件-encrypt
[student@workstation ansible]$ ansible-vault encrypt sec2.txt   
New Vault password: redhat
Confirm New Vault password: redhat
Encryption successful

[student@workstation ansible]$ cat sec2.txt

[student@workstation ansible]$ ansible-vault view sec2.txt
Vault password:
China<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-5-解密现有的文件"><a href="#5-5-解密现有的文件" class="headerlink" title="5.5 解密现有的文件"></a>5.5 解密现有的文件</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#解密现有的文件-decrypt
[student@workstation ansible]$ pwd
/home/student/ansible
[student@workstation ansible]$ ansible-vault decrypt sec2.txt
Vault password: redhat
Decryption successful
[student@workstation ansible]$ cat sec2.txt
China<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-6-更改加密文件的密码"><a href="#5-6-更改加密文件的密码" class="headerlink" title="5.6 更改加密文件的密码"></a>5.6 更改加密文件的密码</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#更改加密文件的密码-rekey
[student@workstation ansible]$ pwd
/home/student/ansible

[student@workstation ansible]$ ansible-vault rekey sec1.txt
Vault password: redhat                  #旧密码 redhat
New Vault password: redhat321           #新密码 redhat321                   
Confirm New Vault password: redhat321   #重复新密码 redhat321
Rekey successful

[student@workstation ansible]$ ansible-vault view sec1.txt
Vault password: redhat321
---
This is a encrypted file!
password: redhat321<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-7-使用密码文件"><a href="#5-7-使用密码文件" class="headerlink" title="5.7 使用密码文件"></a>5.7 使用密码文件</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#查看帮助
[student@workstation ansible]$ pwd
/home/student/ansible

[student@workstation ansible]$ ansible-vault view sec1.txt --help
---省略---
  --vault-id VAULT_IDS  the vault identity to use
  --ask-vault-password, --ask-vault-pass  ask for vault password
  --vault-password-file VAULT_PASSWORD_FILES, --vault-pass-file VAULT_PASSWORD_FILES
                        vault password file
---省略---

[student@workstation ansible]$ echo redhat321 &gt; secret.txt  #创建密码文件
[student@workstation ansible]$ cat secret.txt
redhat321
[student@workstation ansible]$ ansible-vault view sec1.txt --vault-id=secret.txt   #通过变量文件指定密码
---
This is a encrypted file!
password: redhat321                     <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-8-密码文件记录到ansible-cfg配置文件"><a href="#5-8-密码文件记录到ansible-cfg配置文件" class="headerlink" title="5.8 密码文件记录到ansible.cfg配置文件"></a>5.8 密码文件记录到ansible.cfg配置文件</h2><p>  密码文件记录在ansible.cfg配置文件中的好处是，当执行一个使用了加密文件的playbook时，不必手工指定加密文件密码</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ansible]$ vim ansible.cfg          #第一次填写vault路径时，搜索`vault`关键字找该选项
vault_password_file=/home/student/ansible/secret.txt    #配置文件中指定密码文件位置
 
[student@workstation ansible]$ ansible-vault view sec1.txt    #自动调用配置文件中密码文件
---
This is a encrypted file!
password: redhat321

#密码文件记录在配置文件中后
1.加密现有文件时会直接引用
[student@workstation ansible]$ ansible-vault encrypt sec2.txt
Encryption successful

2.更改密码时会直接覆盖
[student@workstation ansible]$ ansible-vault rekey sec2.txt
Rekey successful

3.更改密码需使用--ask-vault-password参数指定
[student@workstation ansible]$ ansible-vault rekey sec2.txt --ask-vault-password
Vault password: redhat
New Vault password: redhat
Confirm New Vault password: redhat
Rekey successful<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="6-管理事实facts"><a href="#6-管理事实facts" class="headerlink" title="6 管理事实facts"></a>6 管理事实facts</h1><p>  Ansible事实是Ansible在受管主机上自动检测到的变量</p>
<p>  事实中含有与主机相关的信息，可以像play中的常规变量、条件、循环或依赖于从受管主机收集的值的任何其他语句那样使用</p>
<p>  为受管主机收集的一些事实可能包括：主机名称、内核版本、网络接口名称、网络接口IP地址、操作系统版本、CPU数量提供的或可用的内存、存储设备的大小和可用空间</p>
<p>  借助事实可以方便地检索受管主机的状态，并根据该状态确定要执行的操作。例如:</p>
<p>   1.根据含有受管主机当前内核版本的事实运行条件任务，以此来重新启动服务器</p>
<p>   2.根据通过事实报告的可用内存来定义MySQL配置文件</p>
<p>   3.根据事实的值设置配置文件中使用的IPv4地址</p>
<p>  每个play在执行第一个任务之前会先自动运行setup模块来收集事实，这在Ansible2.3中报告为GatheringFacts任务或者更早版本中报告为setup。默认情况下，无需具有在play中运行setup的任务，通常会自动运行</p>
<p>  查看受管主机收集的事实的方式是：</p>
<p>   1.使用ad-hoc命令运行setup模块</p>
<p>   2.使用playbook运行debug模块并提取变量var: ansible facts</p>
<h2 id="6-1-收集事实"><a href="#6-1-收集事实" class="headerlink" title="6.1 收集事实"></a>6.1 收集事实</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 收集事实常用两种手段常用是临时命令ad-hoc及Playbook，事实以josn语法格式列出。收集时要找ansible_开头的事实名称
# 如果变量值为散列/字典，则可以用两种语法来检索该值:
ansible_default_ipv4.hostname
ansible_default_ipv4.[ 'hostname' ]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="6-1-1-临时命令-ad-hoc"><a href="#6-1-1-临时命令-ad-hoc" class="headerlink" title="6.1.1 临时命令 ad-hoc"></a>6.1.1 临时命令 ad-hoc</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">1.使用ad-hoc方式收集事实
[student@workstation ansible]$ ansible -m setup all  #收集清单中所有主机的事实
[student@workstation ansible]$ ansible -m setup servera -a filter=ansible_nodename  #过滤

[student@workstation ansible]$ ansible -m setup serverc -a filter=*ipv4*    #过滤&amp;模糊匹配

[student@workstation ansible]$ ansible -m setup serverc &gt; fact.txt   #将事实记录到fact.txt文件中，方便查找<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="6-1-2-PLAYBOOK-收集事实"><a href="#6-1-2-PLAYBOOK-收集事实" class="headerlink" title="6.1.2 PLAYBOOK 收集事实"></a>6.1.2 PLAYBOOK 收集事实</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ansible]$ vim debug.yml
---
- name: debug
  hosts: servera
  tasks:
  - ansible.builtin.debug:
  #简化后可将ansible_facts去掉，二级变量开头，要保留ansible_,如：ansible_default_ipv4.address
      msg: servera ip address "{{ ansible_default_ipv4.address }}"    
  - ansible.builtin.debug:
      var: ansible_hostname 
[student@workstation ansible]$ ansible-navigator run debug.yml -m stdout --syntax-check
playbook: /home/student/ansible/debug.yml

[student@workstation ansible]$ ansible-navigator run debug.yml -m stdout<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="6-1-3-关闭事实"><a href="#6-1-3-关闭事实" class="headerlink" title="6.1.3 关闭事实"></a>6.1.3 关闭事实</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ansible]$ vim debug.yml
---
- name: debug message
  hosts: dev
  gather_facts: on/off  true/false   # 是否关闭事实
  tasks:
  - debug:
      msg: "{{ ansible_facts.default_ipv4.address }}"
      
[greg@bastion ansible]$ ansible-playbook debug.yml

#如果playbook内容和事实收集没有关系，关闭可以大量减少playbook执行时间<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="6-2-魔法变量"><a href="#6-2-魔法变量" class="headerlink" title="6.2 魔法变量"></a>6.2 魔法变量</h2><p>  实时变量通常收集的是受管节点的信息，而魔法变量收集的是本机的变量值</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#inventory_hostname  列出组在清单中的主机名
[student@workstation ansible]$ ansible web -m debug -a var=inventory_hostname

#group_names     列出当前主机归属于哪个组
[student@workstation ansible]$ ansible serverd -m debug -a var=group_names

#groups    列出清单中的所有主机名称。以及所在组
[student@workstation ansible]$ ansible all -m debug -a var=groups

#hostvars  列出系统中所有魔法变量及所有事实变量
[student@workstation ansible]$ ansible all -m debug -a var=hostvars

$ https://docs.ansible.com/ansible/latest/reference_appendices/special_variables.html  #官网文档
# dosc.ansible.com中搜索magic或facts<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="6-2-1-临时命令收集魔法变量值-ad-hoc"><a href="#6-2-1-临时命令收集魔法变量值-ad-hoc" class="headerlink" title="6.2.1 临时命令收集魔法变量值 ad-hoc"></a>6.2.1 临时命令收集魔法变量值 ad-hoc</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ansible  servera -m debug -a var=inventory_hostname
ansible  servera -m debug -a var=groups
ansible  all -m debug -a var=group_names
ansible  all -m debug -a var=hostvars
ansible  servera -m debug -a var=groups.all<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="6-2-2-PLAYBOOK收集事实-魔法变量"><a href="#6-2-2-PLAYBOOK收集事实-魔法变量" class="headerlink" title="6.2.2 PLAYBOOK收集事实+魔法变量"></a>6.2.2 PLAYBOOK收集事实+魔法变量</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ansible]$ vim hoc_debug.yml
---
- name: debug
  hosts: servera
  gather_facts: on
  tasks:
  - ansible.builtin.debug:
     var: hostvars

[student@workstation ansible]$ ansible-navigator run hoc_debug.yml -m stdout --syntax-check
playbook: /home/student/ansible/hoc_debug.yml

[student@workstation ansible]$ ansible-navigator run hoc_debug.yml -m stdout

#重定向到文件中的意义是方便在hoc_fact.txt文件中搜索需要的值
[student@workstation ansible]$ ansible-navigator run hoc_debug.yml -m stdout &gt; hoc_fact.txt   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="6-2-3-魔法变量hostvars"><a href="#6-2-3-魔法变量hostvars" class="headerlink" title="6.2.3 魔法变量hostvars"></a>6.2.3 魔法变量hostvars</h3><p>  临时命令与playbook收集hostvars变量值是不同的</p>
<p>  临时命令不会执行setup模块，所以收集不到事实，PLAYBOOK方法则可以收集到事实和魔法变量</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ansible]$ ansible all -m setup &gt; all_host.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="7-实施任务控制"><a href="#7-实施任务控制" class="headerlink" title="7 实施任务控制"></a>7 实施任务控制</h1><h2 id="7-1-利用循环迭代任务"><a href="#7-1-利用循环迭代任务" class="headerlink" title="7.1 利用循环迭代任务"></a>7.1 利用循环迭代任务</h2><p>  利用循环，管理员无需编写多个使用同一模块的任务</p>
<p>  Ansible支持使用loop关键字对一组项目迭代任务，可以配置循环以利用列表中各个项目、列表中各个文件的内容、生成的数字序列或更为复杂的结构来重复任务</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#loop字段通常在同一缩进的模块下面，对该模块生效，通过item来加载loop循环中的值或变量
#帮助：搜索loop可以搜到相应语法
$ https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="7-1-1-简单循环"><a href="#7-1-1-简单循环" class="headerlink" title="7.1.1 简单循环"></a>7.1.1 简单循环</h3><p>  简单循环对一组项目迭代任务</p>
<p>  loop 关键字添加到任务中，将应对其迭代任务的项目列表取为值</p>
<p>  循环变量item保存每个迭代过程中使用的值</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ansible]$ vim loop.yml
---
- name: service
  hosts: servera
  tasks:
  - name: Start service nfs-server&amp;chronyd
    ansible.builtin.service:
      name: "{{ item }}"
      state: started
    loop:
    - nfs-server
    - chronyd
    
[student@workstation ansible]$ ansible-navigator run loop.yml -m stdout --syntax-check
playbook: /home/student/ansible/loop.yml

[student@workstation ansible]$ ansible-navigator run loop.yml -m stdout<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="7-1-2-循环使用变量"><a href="#7-1-2-循环使用变量" class="headerlink" title="7.1.2 循环使用变量"></a>7.1.2 循环使用变量</h3><p>  在playbook中通过vars或vars files方式加载变量servers中包含循环列表，模块通过loop字段加载servers变量列表中的值</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># vars字段
[student@workstation ansible]$ vim loop.yml
---
- name: service loop
  hosts: servera
  vars:
    servers:
    - nfs-server
    - chronyd
  tasks:
  - name: Start service
    ansible.builtin.service:
      name: "{{ item }}"
      state: stopped
    loop: "{{ servers }}"
   
# vars字段也可以替换为vars_files，将变量保存至文件中，加载到Playbook  
[student@workstation ansible]$ mkdir /home/student/ansible/vars/
[student@workstation ansible]$ vim /home/student/ansible/vars/var.yml
servers:
- nfs-server
- chronyd

[student@workstation ansible]$ vim loop.yml
---
- name: service loop
  hosts: servera
  vars_files:
    - /home/student/ansible/vars/var.yml
  tasks:
  - name: Start service
    ansible.builtin.service:
      name: "{{ item }}"
      state: stopped
    loop: "{{ servers }}"
[student@workstation ansible]$ ansible-navigator run loop.yml -m stdout --syntax-check
playbook: /home/student/ansible/loop.yml

[student@workstation ansible]$ ansible-navigator run loop.yml -m stdout<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="7-1-3-循环字典列表"><a href="#7-1-3-循环字典列表" class="headerlink" title="7.1.3 循环字典列表"></a>7.1.3 循环字典列表</h3><p>  1.循环字典列表保存在loop字段中</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ansible]$ vim loop.yml
---
- name: service loop
  hosts: servera
  tasks:
  - name: Start service
    ansible.builtin.user:
      name: "{{ item.name }}"
      comment: "{{ item.comment }}"
      state: present
    loop:
      - name: jane
        comment: tom
      - name: joe
        comment: harry
        
[student@workstation ansible]$ ansible-navigator run loop.yml -m stdout --syntax-check
playbook: /home/student/ansible/loop.yml

[student@workstation ansible]$ ansible-navigator run loop.yml -m stdout      <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  2.循环字典列表保存在play的vars中</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ansible]$ vim loop.yml
---
- name: service loop
  hosts: servera
  vars:
    users:
    - name: jane
      comment: tom
    - name: joe
      comment: harry
  tasks:
  - name: Start service
    ansible.builtin.user:
      name: "{{ item.name }}"
      comment: "{{ item.comment }}"
      state: present
    loop: "{{ users }}"

[student@workstation ansible]$ ansible-navigator run loop.yml -m stdout --syntax-check
playbook: /home/student/ansible/loop.yml

[student@workstation ansible]$ ansible-navigator run loop.yml -m stdout<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  3.循环字典列表保存在play的vars_files中</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ansible]$ vim /home/student/ansible/vars/var.yml
servers:
users:
- name: jane
  comment: tom
- name: joe
  comment: harry

[student@workstation ansible]$ vim loop.yml
---
- name: service loop
  hosts: servera
  vars_files:
  - /home/student/ansible/vars/var.yml
  tasks:
  - name: Start service
    ansible.builtin.user:
      name: "{{ item.name }}"
      state: present
      comment: "{{ item.comment }}"
    loop: "{{ users }}"

 [student@workstation ansible]$ ansible-navigator run loop.yml -m stdout --syntax-check
playbook: /home/student/ansible/loop.yml

[student@workstation ansible]$ ansible-navigator run loop.yml -m stdout<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="7-2-有条件地运行任务"><a href="#7-2-有条件地运行任务" class="headerlink" title="7.2 有条件地运行任务"></a>7.2 有条件地运行任务</h2><p><img src="/images/%E6%9C%89%E6%9D%A1%E4%BB%B6%E8%BF%90%E8%A1%8C%E4%BB%BB%E5%8A%A1.png"></p>
<p>使用conditionals在符合特定条件时运行任务或play</p>
<p>  条件句可帮助区分不同的受管主机，并根据所符合的条件来分配功能角色</p>
<p>  Playbook变量、注册的变量和Ansible事实都可通过条件句来进行测试，可以使用比较字符串、数字数据和布尔值的运算符</p>
<p>  1.通常主机模式为多个节点时，可以让符合when条件的主机执行模块任务。符合条件则为真，则执行模块。否则为假，跳过模块任务</p>
<p>   when判断对象是模块，和模块在同一下列层次</p>
<p>   when判断当前模块是否执行，而不是它下面模块是否执行</p>
<p>   When中引用变量、facts，不需加大括号</p>
<p>   用于测试条件中相等的==运算符不可与变量赋值的=运算符混淆</p>
<p>  2.一个when语句可用于评估多个值。 可以使用and和or关键字组合条件，或使用括号分组条件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">1.or是或的关系，任意一个条件为真即可
when: ansible_distribution == "RedHat" or ansible_distribution == "Fedora"

2.and是与的关系，多个条件需同时为真
when: ansible_distribution version == "7.5" and ansible_kernel == "3.10.0-327.el7.x86_64"

3. When语句多条件的另外方式:
when:
   -ansible_distribution_version == "7.5"
   -ansible_kernel == "3.10.0-327.el7.x86_64"
4.使用括号分组条件来表达更复杂的条件语句:
when:  &gt;
   ( ansible_distribution == "RedHat" and
     ansible_distribution_major_version == "7")
   or
    ( ansible_distribution == "Fedora" and 
      ansible_distribution_major_version == "28")  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="7-2-1-简单的有条件任务"><a href="#7-2-1-简单的有条件任务" class="headerlink" title="7.2.1 简单的有条件任务"></a>7.2.1 简单的有条件任务</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ansible]$ vim when.yml
---
- name: repository
  hosts: all
  tasks:
  - name: install the latest version of Apache
    ansible.builtin.yum:
      name: httpd
      state: latest
    when: ansible_default_ipv4.address == '172.25.250.10'
    
[student@workstation ansible]$ ansible-navigator run when.yml -m stdout --syntax-check
playbook: /home/student/ansible/when.yml

[student@workstation ansible]$ ansible-navigator run when.yml -m stdout

#如果使用inventory_hostname这个魔法变量，要参考清单中的主机名称。node1位置，单双引号都可以识别为字符串<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="7-2-2-组合循环和有条件任务"><a href="#7-2-2-组合循环和有条件任务" class="headerlink" title="7.2.2 组合循环和有条件任务"></a>7.2.2 组合循环和有条件任务</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ansible]$ vim when_loop.yml
---
- name: 安装软件包
  hosts: all
  tasks:
  - name: install the latest version of Apache
    ansible.builtin.yum:
      name: "{{ item }}"
      state: latest
    loop:
    - php
    - mariadb
    when: ansible_hostname == 'servera' or ansible_hostname == 'serverc'
    
[student@workstation ansible]$ ansible-navigator run when_loop.yml -m stdout --syntax-check
playbook: /home/student/ansible/when_loop.yml
[student@workstation ansible]$ ansible-navigator run when_loop.yml -m stdout<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="7-2-3-常用when条件语句"><a href="#7-2-3-常用when条件语句" class="headerlink" title="7.2.3 常用when条件语句"></a>7.2.3 常用when条件语句</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ansible]$ ansible all -m debug -a var=groups
[student@workstation ansible]$ ansible all -m debug -a var=group_names
#变量值 == '字符串'
inventory_hostname == 'node1'
inventory_hostname != 'node1'
'"52:54:00:00:fa:0b" in ansible_default_ipv4.macaddress'
ansible_default_ipv4.address == '172.25.250.11'

#变量值存在  in  第二个变量
inventory_hostname in groups.dev    #可以匹配组
'"dev" in group_names'              #可以匹配
[student@workstation ansible]$ vim when_loop3.yml
---
- name: repository
  hosts: all
  tasks:
  - name: install the latest version of Apache
    ansible.builtin.yum:
      name: httpd
      state: latest
    when: '"db" in group_names'
[student@workstation ansible]$ ansible-navigator run when_loop3.yml -m stdout --syntax-check
playbook: /home/student/ansible/when_loop3.yml
[student@workstation ansible]$ ansible-navigator run when_loop3.yml -m stdout

#default变量查询方法
#搜索引擎中搜索：filters --- Using filters to --- 搜索admin---default('admin', true) <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="8-实施处理程序"><a href="#8-实施处理程序" class="headerlink" title="8 实施处理程序"></a>8 实施处理程序</h1><p>  handlers是处理程序的一种实现，当对一个Playbook模块改动时，通过监控发现改动，并自动执行后续处理动作</p>
<p>  比如一种场景，当修改了服务配置文件时，需要对服务进行重启，可以在配置文件模块位置用notify监视是否修改后，用handlers中的处理程序如:service模块对其重启服务，达到修改文件便自动重启服务的效果</p>
<h2 id="8-1-Ansible处理程序"><a href="#8-1-Ansible处理程序" class="headerlink" title="8.1 Ansible处理程序"></a>8.1 Ansible处理程序</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ vim handlers.yml
---
- name:
  hosts: servera
  tasks:
  - name: install the latest version of Apache
    ansible.builtin.yum:
      name: httpd
      state: latest
  - name: Copy using inline content
    ansible.builtin.copy:
      content: 'heihei'
      dest: /var/www/html/index.html
    notify: restart            #notify字段冒号后的名称restart，指向handlers中的描述为restart的模块
  - name: Start firewalld
    ansible.builtin.service:
      name: firewalld
      state: started

  handlers:                            #handlers是缩进和tasks对齐
  - name: restart
    ansible.builtin.service:
      name: httpd
      state: restarted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="8-2-执行中对错误的处理"><a href="#8-2-执行中对错误的处理" class="headerlink" title="8.2 执行中对错误的处理"></a>8.2 执行中对错误的处理</h2><p>  Ansible评估各任务的返回代码，从而确定任务是成功还是失败</p>
<p>  通常而言，当任务失败时，ansible将立即在该主机上终止play的其余部分并且跳过所有后续任务</p>
<p>  有些时候，可能希望即使在任务失败时也继续执行play</p>
<h3 id="8-2-1-ignore-errors"><a href="#8-2-1-ignore-errors" class="headerlink" title="8.2.1 ignore_errors"></a>8.2.1 ignore_errors</h3><p>  忽略任务失败 ignore_errors</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ansible]$ vim ignore_errors.yml
---
- name: test error
  hosts: servera
  tasks:
  - name:  touch directory
    ansible.builtin.shell: mkdir /a/b
    ignore_errors: yes
  - name: Add the user
    ansible.builtin.user:
      name: johnd
      
[student@workstation ansible]$ ansible-navigator run ignore_errors.yml -m stdout --syntax-check
[student@workstation ansible]$ ansible-navigator run ignore_errors.yml -m stdout

#也可以在任务失败时强制执行处理程序,详见教材
---
- name: test error
  force_handlers: yes
  tasks:
  - xxxx
  
  handlers:
  - name: haha
    ansible.builtin.service:
    xxx
    xxx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="8-3-Ansible块和错误的处理"><a href="#8-3-Ansible块和错误的处理" class="headerlink" title="8.3 Ansible块和错误的处理"></a>8.3 Ansible块和错误的处理</h2><h3 id="8-3-1-block、rescue、always"><a href="#8-3-1-block、rescue、always" class="headerlink" title="8.3.1 block、rescue、always"></a>8.3.1 block、rescue、always</h3><p>  block：定义要运行的主要任务</p>
<p>  rescue：定义要在block子句中定义的任务失败时运行的任务</p>
<p>  always：定义始终都在独立运行的任务</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">---
- name: block
  hosts: all
  tasks:
  - block:
    - name:
      ansible.builtin.yum:
        name: http
        state: present
    rescue:
    - name:
      ansible.builtin.yum:
        name: httpd
        state: present
    when: inventory_hostname == 'serverb'
    always:
    - name: Start service httpd, if not started
      ansible.builtin.service:
        name: httpd
        state: started
# Ansible官方文档：搜索：rescue https://docs.ansible.com/ansible/latest/user_guide/playbooks_blocks.html        <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="8-3-2-block的使用"><a href="#8-3-2-block的使用" class="headerlink" title="8.3.2 block的使用"></a>8.3.2 block的使用</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#未使用block时：
---
- name: test error
  hosts: all
  tasks:
  - name:  touch file
    ansible.builtin.shell: mkdir  -p /a/b
    when: inventory_hostname == "servera"

  - name: Add the user
    ansible.builtin.user:
      name: johnd
    when: inventory_hostname == "servera"

#使用block时
---
- name: test error
  hosts: all
  tasks:
  - block:
    - name:  touch file
      ansible.builtin.shell: mkdir  -p /a/b

    - name: Add the user
      ansible.builtin.user:
        name: johnd
    when: inventory_hostname == "servera"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="9-文件部署到受管主机"><a href="#9-文件部署到受管主机" class="headerlink" title="9 文件部署到受管主机"></a>9 文件部署到受管主机</h1><h2 id="9-1-将文件复制到主机"><a href="#9-1-将文件复制到主机" class="headerlink" title="9.1 将文件复制到主机"></a>9.1 将文件复制到主机</h2><h3 id="9-1-1-文件模块"><a href="#9-1-1-文件模块" class="headerlink" title="9.1.1 文件模块"></a>9.1.1 文件模块</h3><p>  1.在被管机上创建文件和目录</p>
<p>  2.复制文件(或内容)到被管机 control –&gt; node1</p>
<p>  3.从被管机复制文件到管理机 node1 –&gt; control</p>
<p>  4.修改文件内容</p>
<p>  5.查看文件状态</p>
<p>  6.修改文件属性(所有者、权限、selinux)</p>
<p>  7.文件同步</p>
<p>ansible.builtin-描述文件模块：</p>
<table>
<thead>
<tr>
<th align="left">模块名</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">blockinfile</td>
<td align="left">插入、更新 、删除，自定义标记的多行文本块</td>
</tr>
<tr>
<td align="left">file</td>
<td align="left">设置权限、所有者、SElinux上下文及常规文件、符号连接、硬链接等</td>
</tr>
<tr>
<td align="left">copy</td>
<td align="left">远程copy，类似file，可以设置文件属性、SElinux上下文</td>
</tr>
<tr>
<td align="left">fetch</td>
<td align="left">和copy类似，相反工作方式，从远端拷贝到控制节点</td>
</tr>
<tr>
<td align="left">lineinfile</td>
<td align="left">改文件某一行时使用</td>
</tr>
<tr>
<td align="left">stat</td>
<td align="left">检测文件状态，类似linux中stat命令</td>
</tr>
<tr>
<td align="left">synchronize</td>
<td align="left">围绕rsync一个打包程序</td>
</tr>
</tbody></table>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#查找模块可使用命令
$ ansible-doc -l | grep file
$ ansible-navigator collections -m stdout | grep file$
$ ansible-doc file
#注意：很多模块已经不在ansible.builtin集合中了，所以需要通过ansible-navigator collections命令搜索。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>1.ansible.builtin.file</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">- name: Change file ownership, group and permissions
  ansible.builtin.file:
    path: /var/www/html/index.html
    owner: apache
    group: apache
    mode: '0644'
    state: touch
    setype: default_t
      
#(Choices: absent, directory, file, hard, link, touch)[Default: file]
#file：修改文件内容，无该文件则不修改
#touch：创建文件
#touch，mkdir，cp，mv，rm，ln，chmod，chown，chcon<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2.ansible.builtin.copy</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#复制本机文件到受管节点
- name: Copy file with owner and permissions
  ansible.builtin.copy:
    src: /srv/myfiles/foo.conf
    dest: /var/www/html/index.html
    owner: foo
    group: foo
    mode: '0644'
    setype:  httpd_sys_content_t
    
#复制文本内容testweb至目标文件，文件不存在则创建  
- name: Copy using inline content
  ansible.builtin.copy:
    content: "testweb"
    dest: /var/www/html/index.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>3.ansible.builtin.lineinfile</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ansible]$ ansible-doc -l | grep line
lineinfile                                     Manage lines in text files
[student@workstation ansible]$ ansible-doc lineinfile
[student@workstation ansible]$ vim lineinfile.yml
---
- name: lineinfile
  hosts: all
  tasks:
  - name: Ensure SELinux is set to enforcing mode
    ansible.builtin.lineinfile:
      path: /etc/selinux/config
      regexp: '^SELINUX='
      line: SELINUX=enforcing

[student@workstation ansible]$ ansible-navigator run lineinfile.yml -m stdout --syntax-check
playbook: /home/student/ansible/lineinfile.yml

[student@workstation ansible]$ ansible-navigator run lineinfile.yml -m stdout

#验证:
[student@workstation ansible]$ ansible servera -m shell -a 'cat /etc/selinux/config'

#docs.ansible.com 搜索引擎中搜索：filters --- Using filters to --- 搜索admin---default('admin', true) <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>4.ansible.builtin.blockinfile</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">- name: Insert/Update HTML surrounded by custom markers after &lt;body&gt; line
  ansible.builtin.blockinfile:
    path: /opt/index.html
    marker: "&lt;!-- {mark} ANSIBLE MANAGED BLOCK --&gt;"
    insertafter: "&lt;body&gt;"
    block: |
      &lt;h1&gt;Welcome to {{ ansible_hostname }}&lt;/h1&gt;
      &lt;p&gt;Last updated on {{ ansible_date_time.iso8601 }}&lt;/p&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>5.ansible.builtin.template</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">- name: Template a file to /etc/files.conf
  ansible.builtin.template:
    src: /mytemplates/foo.j2
    dest: /etc/file.conf


- name: Download foo.conf
  ansible.builtin.get_url:   #该模块可以将网络上的文件，直接下载至受管节点上。
    url: http://materials/hosts.j2   #源文件
    dest: /opt/host.txt  #目标文件位置<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="9-2-Jinja2模板部署自定义文件"><a href="#9-2-Jinja2模板部署自定义文件" class="headerlink" title="9.2 Jinja2模板部署自定义文件"></a>9.2 Jinja2模板部署自定义文件</h2><h3 id="9-2-1-jinja2简介"><a href="#9-2-1-jinja2简介" class="headerlink" title="9.2.1 jinja2简介"></a>9.2.1 jinja2简介</h3><p>  ansible中使用jinja2模板对文件进行部署，再用template模块同步jinja2模板文件至受管节点，该模块和copy模块作用基本一样，都是把某个文件复制到被管主机上，但是区别在于template模块可以获取变量的值和使用循环</p>
<p>   1.管理文件通常会使用一些模块，copy，file，blockinfile，lineinfile</p>
<p>   2.更好的配置文件管理方式是使用jinja2语法制作模板文件来生成最终使用的配置文件</p>
<p>   3.jinja2模板文件内，可以通过多种方式编辑或构成，比如魔法变量、事实变量、普通字符、控制语句语法…</p>
<p>   4.使用jinja2模板的方法是，先构建jinja2模板，再通过template模块将j2模板同步至受管节点</p>
<p>   5.构建模板文件通常名称自定义，以.j2结尾，类似shell脚本的.sh、python脚本的.Py</p>
<h3 id="9-2-2-使用分隔符"><a href="#9-2-2-使用分隔符" class="headerlink" title="9.2.2 使用分隔符"></a>9.2.2 使用分隔符</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">1、构建jinja2模板
$ vim jin.j2  #文件名用.j2结尾
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
{# host file #}    #描述，为管理员做提示作用。用户不可见
haha {{ ansible_hostname }}

2、通过templete模块，同步模板文件至受管主机，同时收集事实变量值，将结果生成至相应文件中。
$ vim temp.yml
---
- name: sync file
  hosts: servera
  tasks:
  - name: Template a file to /etc/files.conf
    ansible.builtin.template:
      src: jin.j2
      dest: /etc/myhosts
$ ansible-navigator run temp.yml -m stdout

3、在受管节点上查看文件结果
$ ansible servera -m shell -a 'cat /etc/myhosts'
servera | CHANGED | rc=0 &gt;&gt;
haha
servera heihei servera.lab.example.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="9-2-3-管理模板文件"><a href="#9-2-3-管理模板文件" class="headerlink" title="9.2.3 管理模板文件"></a>9.2.3 管理模板文件</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">1、在配置文件中定义ansible_managed功能，添加描述信息：“Ansible hahaha”
[greg@control ansible]$ vim ansible.cfg
[defaults]
ansible_managed = Ansible hahaha
变量名 =  变量值

2、在jinja2模板中调用该功能
#vim jinja.j2
{# host file #}     #{##}注释客户端生成文件是不显示
{{ ansible_managed }}  #{{}}描述，客户端生成文件时会显示
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="9-2-4-控制结构-使用循环"><a href="#9-2-4-控制结构-使用循环" class="headerlink" title="9.2.4 控制结构-使用循环"></a>9.2.4 控制结构-使用循环</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">-shell
for user in `ls /`;do 
   echo $user
done

-jinja2
{% for user in users %}   #user变量替换为users变量中的所有值，一行一个值。
{{ user }}
{% endfor %}

#示例
$ vim jinja2.j2
{% for host in groups.all %}  #使用for 或if 时控制结构使用{% %}
{{ host }}
{% endfor %}

#查看语法帮助:官网或关键词搜索示例
[student@workstation ansible]$ grep -r '{%' /etc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>1.文件的生成方法</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ vim debug.yml
---
- name:
  hosts: all
  tasks:
  - ansible.builtin.debug:
      var: hostvars
$ ansible-navigator run debug.yml  -m stdout &gt; 1.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2.生成/etc/hosts</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 方法1：
$ vim /home/student/ansible/temp.yml
127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4
::1 localhost localhost.localdomain localhost6 localhost6.localdomain6

{% for host in groups.all %}
{{ hostvars[host].ansible_default_ipv4.address }} {{ hostvars[host].ansible_nodename }} {{ hostvars[host].ansible_hostname }} 
{% endfor %}

#方法2：
vim /home/student/ansible/temp.yml
---
- name: sync file
  hosts: all     
  tasks:
  - name: Template a file to /etc/files.conf
    ansible.builtin.template:
      src: hosts.j2
      dest: /etc/myhosts
    when: inventory_hostname in groups.dev     #匹配dev组
    
$ ansible-navigator run temp.yml -m stdout
$ ansible  servera -m shell -a 'cat /etc/myhosts'

# 以json格式查看：
{{ hostvars[i]['ansible_facts'] |  to_nice_json }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="10-管理大项目"><a href="#10-管理大项目" class="headerlink" title="10 管理大项目"></a>10 管理大项目</h1><h2 id="10-1-引用清单主机"><a href="#10-1-引用清单主机" class="headerlink" title="10.1 引用清单主机"></a>10.1 引用清单主机</h2><h3 id="10-1-1-使用主机模式的方式"><a href="#10-1-1-使用主机模式的方式" class="headerlink" title="10.1.1 使用主机模式的方式"></a>10.1.1 使用主机模式的方式</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#使用主机模式的常见方式：

1.[ad-hoc:]
ansible dev -m shell 

2.[playbook:]
- name:
  hosts: dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="10-1-2-通配符匹配多个主机"><a href="#10-1-2-通配符匹配多个主机" class="headerlink" title="10.1.2 通配符匹配多个主机"></a>10.1.2 通配符匹配多个主机</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 清单里使用通配符匹配多个主机
[START:END]
192.168.[0:15].[0:255] 表示 192.168.0.0-192.168.15.255
server[a:c].example.com  表示   a-c
server[01:15].example.com  表示   server01.example.com-server15
ipv6也可以通过[a:f]这种方式
all： 所有主机
ungrouped ： 不属于任何一个组的所有主机<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="10-1-3-主机模式其他方式"><a href="#10-1-3-主机模式其他方式" class="headerlink" title="10.1.3 主机模式其他方式"></a>10.1.3 主机模式其他方式</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#使用特殊字符时，必须添加单引号，否则不生效
hosts： '*'  和all相同   
hosts：'*.example.com'
hosts：'datacenter*'

#列表形式
hosts：servera,serverb  
hosts：webserver,serverc
hosts：'devops,server*'

#冒号：取代逗号
hosts：lab,&amp;datacenter 匹配lab组同时也属于datacenter组，顺序无所谓&amp;符号时同时也属于的意思
hosts：datacenter,!test2.example.com  表示datacenter组，但不包括test2.。。这个主机
hosts：all,!datacenter1  所有组，但不包含datacenter1组<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="10-2-包含和导入文件"><a href="#10-2-包含和导入文件" class="headerlink" title="10.2 包含和导入文件"></a>10.2 包含和导入文件</h2><h3 id="10-2-1-管理大型Playbook"><a href="#10-2-1-管理大型Playbook" class="headerlink" title="10.2.1 管理大型Playbook"></a>10.2.1 管理大型Playbook</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 如果playbook很长很复杂，可以拆分成较小的文件便于管理，以模块化管理
# 可以将多个不同功能的play，组合成一个主要的playbook，将文件中的任务列表插入play，这样可将这种模块化的play应用到不同场景
playbook
- httpd
- php
- mysql<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="10-2-2-导入Playbook"><a href="#10-2-2-导入Playbook" class="headerlink" title="10.2.2 导入Playbook"></a>10.2.2 导入Playbook</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">1.将两个playbook加入到主playbook
$ vim one.yml 
---
- name: play1
  hosts: node1
  tasks:
  - name: Install the latest version of Apache
    ansible.builtin.yum:
      name: httpd
      state: latest
      
$ vim two.yml      
---
- name: play2
  hosts: node1
  tasks:
  - name: Make sure a service unit is running
    ansible.builtin.systemd:
      state: started
      name: httpd
      enabled: yes
      

2.在主playbook中和其他play交替使用
$ vim main.yml 
---
- name: four
  hosts: node1
  tasks:
  - ansible.builtin.debug:
      msg: haha
  
- name: one     # 因为加载的是playbook所以需要顶头写无缩进
  import_playbook: one.yml

- name: two
  import_playbook: two.yml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="10-2-3-包含与导入"><a href="#10-2-3-包含与导入" class="headerlink" title="10.2.3 包含与导入"></a>10.2.3 包含与导入</h3><p>  Ansible可以支持两种方法将文件放入playbook中：<br>   包含：内容是一个动态操作。在playbook运行期间，Ansible会在内容到达时处理所包含的内容<br>   导入：内容是一个静态操作。在运行开始之前，Ansible在最初解析playbook时预处理导入的内容</p>
<p>1.包含</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">1.使用include_tasks功能时，包含时设置的when等条件语句将确定任务是否包含在play中
2.如果运行ansible-playbook --list-tasks以列出playbook中的任务，则不会显示已包含任务文件中的任务。将显示包含任务文件的任   务。相比之下，import_tasks功能不会列出导入任务文件的任务，而列出已导入任务文件中的各个任务
  #（[greg@control ansible]$ ansible-playbook playbook.yml --start-at-task webserver）
3.不能使用ansible-playbook --start-at-task从已包含任务文件中的任务开始执行playbook
  #（[greg@control ansible]$ ansible-playbook playbook.yml --start-at-task webinstall）
4.不能使用notify语句触发已包含任务文件中的处理程序名称
  可以在包含整个任务文件的主playbook中触发处理程序，在这种情况下，已包含文件中的所有任务都将运行<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2.导入</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">1.使用import_tasks功能时，导入时设置的when等条件语句将应用于导入的每个任务
2.无法将循环用于import_tasks功能
3.如果使用变量来指定要导入的文件的名称，则将无法使用主机或组清单变量<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>3.使用示例</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">第一个tasks任务
[greg@bastion ansible]$ mkdir tasks    #tasks目录是自定义的，创建的目的只是方便存储管理tasks任务文件。
[greg@bastion ansible]$ vim tasks/apache.yml  #tasks任务文件，文件中没有主机模式
---
- name:
  ansible.builtin.yum:
    name: httpd
    state: latest
第二个tasks任务
[greg@bastion ansible]$ vim tasks/service.yml 
---
- name:
  ansible.builtin.service:
    name: httpd
    enabled: yes
    state: started
  
包含和导入的方式：
[greg@bastion ansible]$ vim main.yml   #此处main.yml是一个playbook，有主机模式
---
- name:
  hosts: node1
  tasks:
  - include_tasks: tasks/apache.yml  
  - import_tasks: tasks/service.yml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="11-角色和collections简化Playbook"><a href="#11-角色和collections简化Playbook" class="headerlink" title="11 角色和collections简化Playbook"></a>11 角色和collections简化Playbook</h1><h2 id="11-1-描述角色结构"><a href="#11-1-描述角色结构" class="headerlink" title="11.1 描述角色结构"></a>11.1 描述角色结构</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># Ansible中的角色是结构化的目录组成，可以根据业务需要创建不同的角色，apache的、mysql的等
# 角色的优势是类似将playbook分割成更小的模块，进行模块化管理，简化playbook
# 除了自行编写、使用、重用和共享角色外，也可以从其他来源获取角色以及使用分发包(如Ansible内容集合)查找角色<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="11-2-创建角色"><a href="#11-2-创建角色" class="headerlink" title="11.2 创建角色"></a>11.2 创建角色</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 在playbook的项目目录中创建一个角色，并将其作为playbook中某个play的一部分来运行
1.yum install -y httpd            yum模块
2.index.html, fcontext            copy模块
3.httpd service                   service模块
4.firewalld.service               service模块
5.firewalld permit apache         firewalld模块
# 使用web角色一键部署以上服务<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>  创建和使用角色分四步进行：</p>
<p>   1.创建角色目录存储路径</p>
<p>   2.创建角色</p>
<p>   3.定义角色内容</p>
<p>   4.在playbook中使用角色</p>
<h3 id="11-2-1-角色目录存储路径"><a href="#11-2-1-角色目录存储路径" class="headerlink" title="11.2.1 角色目录存储路径"></a>11.2.1 角色目录存储路径</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 配置ansible.cfg文件中的roles-path,默认ansible会在roles子目录中查找角色
# 可以将自己的角色安装在~/ansible/roles子目录中
1.默认路径：
[student@workstation ansible]$ ansible-galaxy --help

[student@workstation ansible]$ ansible-galaxy role --help    #查看角色的子命令帮助

[student@workstation ansible]$ ansible-galaxy role list     #新版本查看角色指令
[student@workstation ansible]$ ansible-galaxy list           #旧版本查看角色指令
# /usr/share/ansible/roles   -- 系统角色
# /etc/ansible/roles         -- 全局角色路径
[WARNING]: - the configured path /home/student/.ansible/roles does not exist.  --默认该目录不存在，需要的话可以根据需求创建
`如果ansible无法找到该位置角色，会按照ansible.cfg中roles_path指定的目录中查找`

2.创建角色目录存储路径
  使用自定义工作目录时，创建自定义roles(角色)目录，并使用ansible.cfg中roles_path=字段指定角色路径
[student@workstation ansible]$ pwd        #进入自己的工作目录
/home/student/ansible

[student@control ansible]$ mkdir roles    #创建存放角色的目录

[student@control ansible]$ vim ansible.cfg   
roles_path=/home/student/ansible/roles    #指定角色路径

[student@workstation ansible]$ ansible-galaxy list  #要在工作目录中使用查看命令，调用当前工作目录配置文件中的角色路径
# /home/student/ansible/roles                       #查询结果应和配置文件的roles_path字段一致   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="11-2-2-创建角色"><a href="#11-2-2-创建角色" class="headerlink" title="11.2.2 创建角色"></a>11.2.2 创建角色</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@workstation ansible]$ ansible-galaxy role init roles/apache    #创建角色
- Role roles/apache was created successfully

[student@workstation ansible]$ ansible-galaxy role list   #列出所有角色
# /home/student/ansible/roles
- apache, (unknown version)

[student@workstation ansible]$ tree roles/apache/
roles/apache
├── defaults                  #角色默认变量
│   └── main.yml
├── files                     #引用的静态文件，可以是一些文件、网页模板等
├── handlers                  #处理程序，通常通过模块完成的
│   └── main.yml
├── meta                      #作者，许可、兼容性
│   └── main.yml
├── README.md
├── tasks                     #任务，任务的组成就是模块应用，也是角色的主要功能
│   └── main.yml
├── templates                 #模板文件，通常使用jinja2模板
├── tests                     #测试
│   ├── inventory
│   └── test.yml
└── vars                      #角色变量
    └── main.yml

8 directories, 8 files
#用不到的目录可以删除，如defaults、vars、tests<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="11-2-3-定义角色内容"><a href="#11-2-3-定义角色内容" class="headerlink" title="11.2.3 定义角色内容"></a>11.2.3 定义角色内容</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@control ansible]$ tree roles/apache (可选，方便查看路径信息)
*[student@control ansible]$ vim roles/apache/tasks/main.yml   #在tasks目录中完善角色内容
---
- name: install apache     #编写角色时，任务中只有模块任务，没有PLAY
  ansible.builtin.yum:
    name: httpd
    state: latest
- name: Start service httpd
  ansible.builtin.service:
    name: httpd
    state: started
    enabled: yes
- name: create web page
  ansible.builtin.template:
    src: jin2.j2    #jin2.j2需要手动创建
    dest: /var/www/html/index.html
  notify:
  - restart   #需要时将调用handlers处理程序，需要手动创建，restart通知中的处理程序名要和handlers/main.yml中处理程序描述一致
- name: Start service firewalld
  ansible.builtin.service:
    name: firewalld
    state: started
    enabled: yes
    
- name: permit apache
  ansible.posix.firewalld:    
    service: http
    permanent: yes
    state: enabled
    immediate: yes
    
#ansible-navigator collections可以查看posix集合 
#ansible-navigator doc ansible.posix.firewalld -m stdout 

#以上25-30行客替换为如下:
- name: permit apache
  ansible.builtin.shell: firewall-cmd --permanent --add-service=http  
- name: permit apache
  ansible.builtin.shell: firewall-cmd --reload
      
[student@control ansible]$ vim roles/apache/templates/jin2.j2  #编写模板文件
ipadd={{ ansible_default_ipv4.address }}  hostname={{ ansible_hostname }}

[student@control ansible]$ vim roles/apache/handlers/main.yml   #编写处理程序
---
- name: restart 
  ansible.builtin.service:
    name: httpd
    state: restarted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="11-2-4-playbook中使用角色"><a href="#11-2-4-playbook中使用角色" class="headerlink" title="11.2.4 playbook中使用角色"></a>11.2.4 playbook中使用角色</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[student@bastion ansible]$ vim roles.yml
---
- name:
  hosts: servera
  roles:     #roles字段用来调用角色
  - apache   #被调用角色的名称
  - xxx
[student@bastion ansible]$ ansible-navigator run -m stdout roles.yml  
[student@control ansible]$ curl servera
ipadd=172.25.250.10  hostname=servera<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="11-3-外部内容源部署角色"><a href="#11-3-外部内容源部署角色" class="headerlink" title="11.3 外部内容源部署角色"></a>11.3 外部内容源部署角色</h2><p>  从Git存储库或AnsibleGalaxy等外部资源中选择和检索角色，并在playbook中使用</p>
<p>  <a target="_blank" rel="noopener" href="https://galaxy.ansible.com/">https://galaxy.ansible.com</a></p>
<h3 id="11-3-1-外部内容来源"><a href="#11-3-1-外部内容来源" class="headerlink" title="11.3.1 外部内容来源"></a>11.3.1 外部内容来源</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#角色有多种获取方式：
1.本地tar包安装   2.通过网络地址安装   3.通过文件同时安装网络中多个地址角色

roles/requirements.yml
- src： #角色网址
  varsion：#角色版本
  name：#安装在本地的角色名
- src：
  name：

ansible-galaxy role install -r roles/requirements.yml -p roles
-r 指定文件路径
-p 指定角色安装路径
roles/requirements.yml  角色安装信息，包括地址，角色名称等<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="11-3-2-角色部署"><a href="#11-3-2-角色部署" class="headerlink" title="11.3.2 角色部署"></a>11.3.2 角色部署</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#示例：
1.将phpinfo.tar,haproxy.tar上传到Linux，kiosk家目录下，用kiosk登录
2.将两个角色包拷贝到foundation0的rhel9.0目录中
$ ssh root@localhost cp /home/kiosk/{phpinfo.tar,haproxy.tar} /content/courses/rh294/rhel9.0/materials
3.打开foundation0的浏览器输入http://172.25.254.254/materials/就可以看到两个软件包

[student@workstation ansible]$ mkdir roles
[student@workstation ansible]$ $ vim ansible.cfg
[defaults]
roles_path=/home/student/ansible/roles
[student@workstation ansible]$ vim roles/requirements.yml
---
- src: http://172.25.254.254/materials/haproxy.tar
  name: balancer
- src: http://172.25.254.254/materials/phpinfo.tar
  name: phpinfo

[student@workstation ansible]$ ansible-galaxy install -r roles/requirements.yml 
[student@workstation ansible]$ ansible-galaxy list
# /home/student/ansible/roles
- apache, (unknown version)
- balancer, (unknown version)
- phpinfo, (unknown version)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="11-4-内容集合获取角色和模块"><a href="#11-4-内容集合获取角色和模块" class="headerlink" title="11.4 内容集合获取角色和模块"></a>11.4 内容集合获取角色和模块</h2><p>  从Ansible内容集合中获取一组相关角色、补充模块和其他内容，并在playbook中使用</p>
<h3 id="11-4-1-Ansible内容集合"><a href="#11-4-1-Ansible内容集合" class="headerlink" title="11.4.1 Ansible内容集合"></a>11.4.1 Ansible内容集合</h3><p>  1.随着模块数量增加，管理困难。模块需要唯一名称，并保持更新</p>
<p>  2.借助Ansible内容集合，Ansible代码可以与模块和插件分开更新</p>
<p>  3.Ansible 内容集合可提供一组在playbook中使用的相关模块、角色和其他插件，便于供应商和开发人员按照自己的节奏维护和分发集合，而不受Ansible版本的影响</p>
<h3 id="11-4-2-Ansible内容集合的命名空间"><a href="#11-4-2-Ansible内容集合的命名空间" class="headerlink" title="11.4.2 Ansible内容集合的命名空间"></a>11.4.2 Ansible内容集合的命名空间</h3><p>  1.命名空间是集合名称的第一部分</p>
<p>  2.由Ansible社区维护的所有集合可能会放入community命名空间中名称类似于：</p>
<p>   community.crypto</p>
<p>   community.postgresql</p>
<p>   community.rabbitmq</p>
<p>  3.红帽直接维护和支持的Ansible内容集合可能使用redhat命名空间有：<br>   redhat.rhv<br>   redhat.satellite<br>   redhat.insights等名称</p>
<h3 id="11-4-3-Ansible内容集合的来源"><a href="#11-4-3-Ansible内容集合的来源" class="headerlink" title="11.4.3 Ansible内容集合的来源"></a>11.4.3 Ansible内容集合的来源</h3><p>  无论是将ansible-navigator 用于最小自动化执行环境，还是在裸机Ansible Core上使用ansible-playbook，始终至少有一个可用Ansible内容集合:ansible.builtin</p>
<p>  自动化执行环境可能还内置了其他自动化执行环境，例如，红帽Ansible 自动化平台2.2使用的默认执行环境ee-supported-rhel8</p>
<p>  如果需要其他Ansible内容集合，可以将其添加到Ansible项目的collections子目录中，可以从多个来源获取Ansible内容集合：</p>
<p>   1.自动化中心</p>
<p>   2.私有自动化中心</p>
<p>   3.Ansible Galaxy</p>
<p>   4.第三方Git存储库或存档文件</p>
<h3 id="11-4-4-安装Ansible内容集合"><a href="#11-4-4-安装Ansible内容集合" class="headerlink" title="11.4.4 安装Ansible内容集合"></a>11.4.4 安装Ansible内容集合</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#配置文件ansible.cfg中设置了collections_paths选项来指定集合的默认路径：
~/.ansible/collections;/usr/share/ansible/collections 
#如果消除这两个目录的指定，则ansible-navigator无法在这些目录的其版本中找到自动化执行环境内提供的Ansible内容集合
$ ansible-galaxy collection install 集合 -p collections
-p collections 选项会将该集合安装到本地collections子目录中或者不适用-p，而在ansible.cfg文件中collections_paths选项来指定集合的默认路径

#集合的来源可以是：本地、互联网、git仓库<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>1.使用要求文件安装Ansible内容集合</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 1.将三个集合包上传到Linux，kiosk家目录下，用kiosk登录
# 2.将三个集合包拷贝到foundation0的rhel9.0目录中
  $ ssh root@localhost cp /home/kiosk/{community-general-5.5.0.tar.gz,redhat-insights-1.0.7.tar.gz,redhat-rhel_system_roles-1.19.3.tar.gz} /content/courses/rh294/rhel9.0/materials
# 3.打开foundation0的浏览器输入http://172.25.254.254/materials/就可以看到两个软件包

【workstation】
1.创建存储集合的位置
$ mkdir /home/student/ansible/mycollections  
$ vim ansible.cfg
[defaults]
...  
#集合默认路径不删除，额外添加当前用户工作目录中集合路径
collections_path=/home/student/ansible/mycollection:~/.ansible/collections:/usr/share/ansible/collections 

2.部署requirements.yml文件
$ vim /home/student/ansible/mycollections/requirements.yml
---
collections:
- name: http://172.25.254.254/materials/community-general-5.5.0.tar.gz
- name: http://172.25.254.254/materials/redhat-insights-1.0.7.tar.gz
- name: http://172.25.254.254/materials/redhat-rhel_system_roles-1.19.3.tar.gz

3.安装集合
$ ansible-galaxy collection install -r requirements.yml -p /home/student/ansible/collections/mycollections
$ ansible-galaxy collection list<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="11-5-利用系统角色重用内容"><a href="#11-5-利用系统角色重用内容" class="headerlink" title="11.5 利用系统角色重用内容"></a>11.5 利用系统角色重用内容</h2><p>  编写利用红帽帽企业Linux的系统角色执行标准操作的 playbook</p>
<h3 id="11-5-1-内容集合安装系统角色"><a href="#11-5-1-内容集合安装系统角色" class="headerlink" title="11.5.1 内容集合安装系统角色"></a>11.5.1 内容集合安装系统角色</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#内容集合 redhat.rhel_system_roles

$ mkdir /home/student/ansible/collections
$ vim /home/student/ansible/collections/requirements.yml
---
collections
name: redhat.rhel system roles

$ ansible-galaxy collection install -p collections/ -r home/student/ansible/collections/requirements.yml

$ sudo find ./mycollection/ -name  selinux-playbook.yml #不安装角色包可以使用该条命令搜索
$ find mycollection/ -name '*.yml' | grep selinux
$ cp /usr/share/ansible/collections/ansible_collections/redhat/rhel_system_roles/docs/selinux/selinux-playbook.yml /home/student/ansible/selinux.yml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="11-5-2-rpm包安装系统角色"><a href="#11-5-2-rpm包安装系统角色" class="headerlink" title="11.5.2 rpm包安装系统角色"></a>11.5.2 rpm包安装系统角色</h3><p>1.系统角色使用流程</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">1.通过软件安装获得系统角色（rhel-system-roles.noarch）
2.定义系统角色路径（存放角色的位置），并将其记录配置文件
cd /;ansible-galaxy list   , vim ~/ansible/ansible.cfg/;roles_path=xxxx:xxxx
3.使用系统角色，将系统角色添加至playbook，并修改内容
4.应用<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2.安装系统角色</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">1.安装
系统帮助我们定义了一些角色，有不同的功能，需要通过安装软件包。
[greg@control ansible]$ cd /
[greg@control /]$ sudo yum search roles
[greg@control /]$ sudo yum install -y rhel-system-roles.noarch     
[greg@control /]$ ansible-galaxy list    #在根目录下查看角色路径，该路径为默认系统角色路径
# /usr/share/ansible/roles     #系统角色路径
- linux-system-roles.kdump, (unknown version)
....
- rhel-system-roles.timesync, (unknown version)
# /etc/ansible/roles
 [WARNING]: - the configured path /home/greg/.ansible/roles does not exist.
 
 
2.定义角色路径
[greg@control /]$ cd ~/ansible/   #在ansible工作目录中查看时属于greg用户定制的角色路径
[greg@control ansible]$ vim ansible.cfg
roles_path    = /home/greg/ansible/roles:/usr/share/ansible/roles #:冒号分割，并添加系统角色路径
[greg@control ansible]$ ansible-galaxy list
# /home/greg/ansible/roles                        #之前定义好的自定义角色路径
- apache, (unknown version)
# /usr/share/ansible/roles                      #系统角色路径
- linux-system-roles.kdump, (unknown version)
......
- rhel-system-roles.timesync, (unknown version)

3.使用系统角色，将系统角色添加至playbook并应用
[greg@control ansible]$ rpm -ql rhel-system-roles.noarch | grep timesync #看README.md
[greg@control ansible]$ cp /usr/share/doc/rhel-system-roles/timesync/example-timesync-playbook.yml /home/greg/ansible/timesync.yml   #找例子，并复制到工作目录中
[greg@control ansible]$ vim timesync.yml      #编辑角色
---
- hosts: all
  vars:
    timesync_ntp_servers:
      - hostname: 172.25.254.254
        iburst: yes
  roles:
    - rhel-system-roles.timesync

4.使用系统角色
[greg@control ansible]$ ansible-playbook timesync.yml

查询验证
ansible all -a 'chronyc sources -v'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="11-5-3-通过内容集合安装使用系统角色"><a href="#11-5-3-通过内容集合安装使用系统角色" class="headerlink" title="11.5.3 通过内容集合安装使用系统角色"></a>11.5.3 通过内容集合安装使用系统角色</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 1.timesync
$ cp /usr/share/ansible/collections/ansible_collections/redhat/rhel_system_roles/docs/timesync/multiple-ntp-servers.yml  timesync.yml
$ vim timesync.yml
- hosts: all
  vars:
    timesync_ntp_servers:
      - hostname: 172.25.254.254
        iburst: yes
  roles:
    - redhat.rhel_system_roles.timesync
$ ansible-navigator run timesync.yml -m stdout
$ ansible all -m shell -a 'chronyc sources -v '

# 2.selinux
$ cp /usr/share/ansible/collections/ansible_collections/redhat/rhel_system_roles/docs/selinux/selinux-playbook.yml selinux.yml
$ vim selinux.yml
---
- hosts: all
  vars:
    selinux_policy: targeted
    selinux_state: permissive

  roles:
  - redhat.rhel_system_roles.selinux
$ ansible-navigator run selinux.yml  -m stdout
# 验证
$ ansible all -m shell -a 'grep ^SELINUX= /etc/selinux/config'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="11-6-通过文件安装角色"><a href="#11-6-通过文件安装角色" class="headerlink" title="11.6 通过文件安装角色"></a>11.6 通过文件安装角色</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Ansible官网：https://docs.ansible.com/ansible/2.9/galaxy/user_guide.html#installing-roles-from-galaxy

https://galaxy.ansible.com/nginxinc/nginx_core  #该网站可以查看角色包信息

#实验需要在模拟考试环境下做，普通环境没有角色包
[greg@control ansible]$ vim roles/requirements.yml  #制作角色部署文件
---
- src: http://materials/phpinfo.tar    #角色在网络中的路径
  name: phpinfo                           #指定安装在系统中的角色名称
- src: http://materials/haproxy.tar
  name: balancer
  
[greg@control ansible]$ ansible-galaxy install --help
[greg@control ansible]$ ansible-galaxy install -r roles/requirements.yml  #-r 指定角色文件
[greg@control ansible]$ ansible-galaxy list   #检测
# /home/greg/ansible/roles
- phpinfo, (unknown version)    #查看结果
- balancer, (unknown version)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="12-对Ansible进行故障排除"><a href="#12-对Ansible进行故障排除" class="headerlink" title="12 对Ansible进行故障排除"></a>12 对Ansible进行故障排除</h1><h2 id="12-1-对playbook进行故障排除"><a href="#12-1-对playbook进行故障排除" class="headerlink" title="12.1 对playbook进行故障排除"></a>12.1 对playbook进行故障排除</h2><h3 id="12-1-1-调试Playbook"><a href="#12-1-1-调试Playbook" class="headerlink" title="12.1.1 调试Playbook"></a>12.1.1 调试Playbook</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">-rhel8
ansible-playbook debug.yml -v   #显示详细信息-v -vv -vvv -vvvv

-rhel9
ansible-navigator run playbook.yml -m stdout -v<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="12-1-2-Debug"><a href="#12-1-2-Debug" class="headerlink" title="12.1.2 Debug"></a>12.1.2 Debug</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#通过debug模块打印收集到的变量信息，帮助管理员了解模块执行过程及结果
---
- hosts: serverb
  tasks:
  - name: install the latest version of Apache
    ansible.builtin.yum:
      name: vsftpd
      state: latest
    register: web_install   #注册变量收集模块的执行信息
  - ansible.builtin.debug:
      var: web_install      #debug模块可以帮助打印出执行信息

#可以一次性将hostvars收集到的所有魔法及事实变量打印出来，并可以记录到文件中
[greg@control ansible]$ vim debug.yml
---
- name: test
  hosts: node1
  tasks:
  - ansible.builtin.debug:
      var: hostvars
[greg@control ansible]$ ansible-navigator run -m stdout debug.yml &gt; 2.txt 
 

关闭事实收集
如果要关闭收集，可以编辑配置文件
gathering = explicit
或者在playbook里
gather_facts: yes/no  true/false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="12-1-3-检查Playbook的错误"><a href="#12-1-3-检查Playbook的错误" class="headerlink" title="12.1.3 检查Playbook的错误"></a>12.1.3 检查Playbook的错误</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">-RHEL8
$ ansible-playbook playbook.yml --syntax-check
playbook: playbook.yml

-RHEL9
greg@control ansible]$ ansible-navigator run -m stdout debug.yml   --syntax-check
playbook: /home/greg/ansible/debug.yml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="12-1-4-检查Playbook的问题"><a href="#12-1-4-检查Playbook的问题" class="headerlink" title="12.1.4 检查Playbook的问题"></a>12.1.4 检查Playbook的问题</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#常见语法问题
name：  冒号后面要空格，内容随意
hosts： all 指定的主机不在清单中，报错无partten
syntax-errors：注意格式缩进，2格缩进
变量设置错误，或调用时错误（变量名写错，变量开头要加双引号）  
when条件： （逻辑判断思路错误，或书写错误）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="12-1-5-检查Playbook工件和日志文件"><a href="#12-1-5-检查Playbook工件和日志文件" class="headerlink" title="12.1.5 检查Playbook工件和日志文件"></a>12.1.5 检查Playbook工件和日志文件</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># ansible-navigator可以生成playbook工件，以JSON格式存储与playbook的运行相关的信息
# 可以将与playbook运行相关的信息记录到系统上您可写入位置处的文本文件中
# RHEL9中的ansible自动开启日志功能，可通过配置文件设置及手工设置

# 配置文件
$ vim ~/.ansible-navigator.yml
---
ansible-navigator:
  execution-environment:
    image: utility.lab.example.com/ee-supported-rhel8:latest
    pull:
      policy: missing
  playbook-artifact:
    enable: false    # false/true 关闭/打开

# 手工指定
--pae  --playbook-artifact-enable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="12-1-6-输出记录到文本文件"><a href="#12-1-6-输出记录到文本文件" class="headerlink" title="12.1.6 输出记录到文本文件"></a>12.1.6 输出记录到文本文件</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">-RHEL8&amp;9

1.Ansible提供了一个内置日志基础架构，可通过ansible.cfg配置文件[defaults]部分中的log_path参数或$ANSIBLE_LOG_PATH环境变   量进行配置。在进行上面一项或两项配置后，Ansible会以文本形式将ansible-navigator命令的输出存储到所配置的日志文件中。此机制   也适用于ansible-playbook等早期的工具
2.如果将Ansible配置为将日志文件写入/var/log，红帽建议您配置logrotate来管理文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="12-2-对Ansible受管主机进行故障排除"><a href="#12-2-对Ansible受管主机进行故障排除" class="headerlink" title="12.2 对Ansible受管主机进行故障排除"></a>12.2 对Ansible受管主机进行故障排除</h2><h3 id="12-2-1-Ansible运行临时命令"><a href="#12-2-1-Ansible运行临时命令" class="headerlink" title="12.2.1 Ansible运行临时命令"></a>12.2.1 Ansible运行临时命令</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># ad-hoc命令可以用于简单部署场景，比如对一组目标部署一个任务，或检索受管节点的运行情况、状态等
ansible all -m ping

# RHEL9中默认不允许root用户登录，需要修改配置文件允许root登录。所建议使用普通用户作为远程管理用户
# 解决方法,服务器端：
$ vim /etc/ssh/sshd_config
# PermitRootLogin prohibit-password
PermitRootLogin yes
$ systemctl  reload sshd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="12-2-2-手动控制执行"><a href="#12-2-2-手动控制执行" class="headerlink" title="12.2.2 手动控制执行"></a>12.2.2 手动控制执行</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ ansible-playbook playbook.yml --step
$ ansible-navigator run playbook.yml  -m stdout --step

PLAY [PLAY1] ********************************************************************************************
Perform task: TASK: Gathering Facts (N)o/(y)es/(c)ontinue: n

#手动输入n  y c来控制playbook中执行的步骤
1.n 不执行该步骤
2.y 执行该步骤
3.c 继续自动执行到结束
# 通过该方法可以让有问题的步骤执行，而无关紧要的步骤可以跳过不执行。达到排错的目的<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="12-2-3-从指定步骤执行任务"><a href="#12-2-3-从指定步骤执行任务" class="headerlink" title="12.2.3 从指定步骤执行任务"></a>12.2.3 从指定步骤执行任务</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[greg@control ansible]$ ansible-playbook playbook.yml --start-at-task='Start service httpd'

--start-at-task   #指定具体执行步骤，等号后面指定模块的描述，如果描述内容中有空格，建议用单或双引号引起来，表示为一个参数<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="12-2-4-烟雾测试"><a href="#12-2-4-烟雾测试" class="headerlink" title="12.2.4 烟雾测试"></a>12.2.4 烟雾测试</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 烟雾测试：在管理节点执行剧本，显示剧本的真实执行结果，但是不在受管节点上部署
$ ansible-playbook playbook.yml --help | grep \\-C
$ ansible-navigator run playbook.yml  -m stdout -C
[greg@control ansible]$ vim playbook.yml
---
- name: PLAY1
  hosts: node2
  tasks:
  - name: install  apache
    ansible.builtin.yum:
      name: httpd
      state: latest
  - name: Copy using inline content
    ansible.builtin.copy:
      content: 'test web page'
      dest: /var/www/html/index.html
  - name: Start service httpd
    ansible.builtin.service:
      name: httpd
      state: started
  - name: Start service firewalld
    ansible.builtin.service:
      name: firewalld
      state: started
  - name: permit apache
    ansible.posix.firewalld:
      service: http
      permanent: yes
      state: enabled
      immediate: yes
[greg@control ansible]$ ansible-playbook playbook.yml -C<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="12-2-5-发送脚本解决问题"><a href="#12-2-5-发送脚本解决问题" class="headerlink" title="12.2.5 发送脚本解决问题"></a>12.2.5 发送脚本解决问题</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ vim test.sh   #自定义脚本名及内容
#!/bin/bash
date
$ vim debug.yml #剧本名自定义
---
- name:
  hosts: node1
  tasks:
  - name: Run a script
    ansible.builtin.script: /home/greg/ansible/test.sh    #使用script模块，加脚本文件路径
    register: haha   #register收集上面模块执行结果至 haha（自定义名称）的这个变量中
  - ansible.builtin.debug:
      var: haha   #通过debug模块将haha变量的值打印出来。
$ ansible-playbook debug.yml     

`如果不想写register，可以执行剧本时添加-v 类似：ansible-playbook debug.yml -v`<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="13-自动执行Linux管理任务"><a href="#13-自动执行Linux管理任务" class="headerlink" title="13 自动执行Linux管理任务"></a>13 自动执行Linux管理任务</h1><h2 id="13-1-管理软件和订阅"><a href="#13-1-管理软件和订阅" class="headerlink" title="13.1 管理软件和订阅"></a>13.1 管理软件和订阅</h2><h3 id="13-1-1-优化多软件包安装"><a href="#13-1-1-优化多软件包安装" class="headerlink" title="13.1.1 优化多软件包安装"></a>13.1.1 优化多软件包安装</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ansible.builtin.---

- name:
  hosts: all
  tasks:
  - name: install the latest version of Apache
    ansible.builtin.yum:
      name: httpd   #httpd
      state: latest
  - name: install the latest version of Apache
    ansible.builtin.yum:
      name: php   #php
      state: latest
---------------------------------------------
- name: install the latest version of Apache
  ansible.builtin.yum:
      name: "{{ item }}"
      state: latest
  loop:　    #用loop方式简化playbook
    - httpd
    - php
      
yum install -y httpd
yum install -y php
---------------------------------------------
- name: install the latest version of Apache
  ansible.builtin.yum:
    name: 
    - httpd
    - php
    state: latest
yum install -y httpd php
--------------------------------------------- 
- name: ensure a list of packages installed
  ansible.builtin.yum:
    name: "{{ packages }}"
  vars:
    packages:
    - httpd
    - httpd-tools
--------------------------------------------- 
      
# 等同于：yum install -y httpd php或 loop的这种方式，系统会执行两次独立事务，对每个事务应用一个软件包
# yum模块：
  state： absent删除, installed,  present确保安装  latest升级到最新版本
  latest 等同  yum update

 name： '*'  代表所有软件包
 name: "@RPM Development tools"   ansible命令里面安装包组要加@<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="13-1-2-收集已安装软件包的事实"><a href="#13-1-2-收集已安装软件包的事实" class="headerlink" title="13.1.2 收集已安装软件包的事实"></a>13.1.2 收集已安装软件包的事实</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">---
- name:
  hosts: node1
  tasks:
  - name: Gather the package facts
    ansible.builtin.package_facts:
      manager: auto

  #- name: Print the package facts
  #  ansible.builtin.debug:
  #    var: ansible_facts.packages

  - name: Check whether a package called foobar is installed
    ansible.builtin.debug:
      msg: "{{ ansible_facts.packages.zip.0.version }}"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="13-1-3-管理软件包的其他模块"><a href="#13-1-3-管理软件包的其他模块" class="headerlink" title="13.1.3 管理软件包的其他模块"></a>13.1.3 管理软件包的其他模块</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">- name: Install httpd on RHEL 8 and 9
  ansible.builtin.dnf
    name: httpd
    state: present

- name: Install httpd on RHEL 7 and earlier
  ansible.builtin.yum:
    name:httpd
    state:present<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="13-1-4-RPM软件包存储库"><a href="#13-1-4-RPM软件包存储库" class="headerlink" title="13.1.4 RPM软件包存储库"></a>13.1.4 RPM软件包存储库</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ ansible-doc -l | grep yum

---
- name:
  hosts: node1
  tasks:
  - name: Add multiple repositories into the same file (1/2)
    ansible.builtin.yum_repository:
      name: EX294_BASE #file字段不存在时，默认用name字段代替源文件名称
      description: EX294 base software
      file: rhel  #file选项作用是定义yum源文件名称，无该字段时会用name字段后的值代替文件名 例如：rhel.repo
      baseurl: http://content/rhel8.4/x86_64/dvd/BaseOS
      gpgcheck: yes
      gpgkey: http://content/rhel8.4/x86_64/dvd/RPM-GPG-KEY-redhat-release
      enabled: yes
      
  - name: Add multiple repositories into the same file (1/2)
    ansible.builtin.yum_repository:
      name: EX294_STREAM
      description: EX294 stream software
      file: rhel  #多个模块使用同一个file字段的名称时，会将源地址写入到同一个文件中。
      baseurl: http://content/rhel8.4/x86_64/dvd/AppStream
      gpgcheck: yes
      gpgkey: http://content/rhel8.4/x86_64/dvd/RPM-GPG-KEY-redhat-release
      enabled: yes  #enabled默认值为yes，考试时要写该选项。


ansible模块选项和vim配置文件内容对比
  vim：                ansible：
      rhel.repo          file
      [rhel]            * name
      name=rhel         * description
      baseurl=            * baseurl
      gpgcheck=            * gpgcheck
      gpgeky=            * gpgkey
      enabled=            * enabled     
      
#测试方法：$ ansible all -a 'yum repolist all'
# 受管节点检测  $ cat rhel.repo
$ ansible-doc rpm_key   
- ansible.builtin.rpm_key:
    state: present
    key: http://apt.sw.be/RPM-GPG-KEY.dag.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="13-2-管理用户和身份验证"><a href="#13-2-管理用户和身份验证" class="headerlink" title="13.2 管理用户和身份验证"></a>13.2 管理用户和身份验证</h2><h3 id="13-2-1-user模块"><a href="#13-2-1-user模块" class="headerlink" title="13.2.1 user模块"></a>13.2.1 user模块</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">#在servera上创建用户tom 附加组为group1，并设置密码为password tom: tom123用sha512方式哈希，uid =2000
#user这个模块类似这些功能： useradd userdel usermod

$ cat group.yml     
- name:
  hosts: node1
  vars:
  - passwordtom: tom123
  tasks:
  - name:  create group
    ansible.builtin.group:
      name: "{{ item }}"
    loop:
      - group1
      - group2
  - name: Add the
    ansible.builtin.user:
      name: tom            #useradd tom
      comment: student     #useradd -c student
      uid: 2000            #useradd -u 2000
      password_expire_max: 10     #passwd -e 10
      group: group1             #useradd -g group1
      groups: group1,group2     #-G group1,group2
      shell: /bin/bash          #-s /bin/bash
      password: "{{ passwordtom | password_hash('sha512') }}"    passwd tom
      #passwordtom该密码位置如果是字符串用单引号引起来，如果是变量则不需要单引号
      
          
#验证用户密码过期时间
chage -l tom
Password expires                    : Jun 11, 2024
#验证用户密码是否正确，可以从node2登录node1，测试node1上的tom用户
ssh tom@node1

Ansible网页搜索：password_hash--Using filter--网页中查找password_hash，查看密码哈希方式，一定注意是512
Ansible官网：  https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html
      模块中：append: yes    如果想额外添加附加群组，此选项需要yes(usermod -a -G  grouptest u1) <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="13-2-2-group模块"><a href="#13-2-2-group模块" class="headerlink" title="13.2.2 group模块"></a>13.2.2 group模块</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[greg@bastion ansible]$ cat group.yml 
---
- name:
  hosts: dev
  tasks:
  - name: Ensure group "grouptest" exists
    ansible.builtin.group:
      gid: 10000
      name: grouptest
      state: present | absent   #创建|删除 二选一

#等同于：groupadd  grouptest
#等同于：groupadd -g 10000 grouptest
#groupdel<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="13-3-管理启动过程和调度进程"><a href="#13-3-管理启动过程和调度进程" class="headerlink" title="13.3 管理启动过程和调度进程"></a>13.3 管理启动过程和调度进程</h2><h3 id="13-3-1-at"><a href="#13-3-1-at" class="headerlink" title="13.3.1 at"></a>13.3.1 at</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">---
- name:
  hosts: dev
  tasks:
  - name: Schedule a command to execute in 20 minutes as root
    ansible.posix.at:
      command: ls -d / &gt;/dev/null
      count: 20
      units: minutes
# 默认是创建一个任务，给root，删除的    话使用选项state：absent<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="13-3-2-cron"><a href="#13-3-2-cron" class="headerlink" title="13.3.2 cron"></a>13.3.2 cron</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[greg@bastion ansible]$ ansible-doc cron
[greg@bastion ansible]$ cat cron.yml 
---
- name:
  hosts: all
  tasks:
  - name: Ensure a job that runs at 2 and 5 exists. 
    ansible.builtin.cron:
      name: "check dirs"  #描述  
      minute: "*/2"          #分钟
      hour: "2,5"         #小时
      day: 1-10           #天
      user: harry
      job: "ls -alh &gt; /dev/null"
     
[greg@bastion ansible]$ ansible dev -m shell -a 'crontab -u harry -l'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="13-3-3-管理服务"><a href="#13-3-3-管理服务" class="headerlink" title="13.3.3 管理服务"></a>13.3.3 管理服务</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">---
- name:
  hosts: dev
  tasks:
  - name: install the latest version of Apache
    ansible.builtin.yum:
      name: httpd
      state: latest
          
  - name: Start service httpd, if not started
    ansible.builtin.service:
      name: httpd
      state: started
      enabled: yes    #开机自启动<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="13-3-4-systemd"><a href="#13-3-4-systemd" class="headerlink" title="13.3.4 systemd"></a>13.3.4 systemd</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[greg@bastion ansible]$ cat systemd.yml 
---
- name:
  hosts: dev
  tasks:
  - name: install the latest version of Apache
    ansible.builtin.yum:
      name: httpd
      state: latest

  - name: Make sure a service is running
    ansible.builtin.systemd:
      name: httpd
      state: started
      enabled: yes
      
测试命令：
ansible dev -m shell -a 'systemctl status httpd'
ansible dev -m shell -a 'systemctl is-enabled httpd'

# 1.reboot
- name: Unconditionally reboot the machine with all defaults
  reboot:
  
# 2.command &amp; shell  支持更多的特殊字符
$ ansible servera -m command -a 'useradd user1'
$ ansible servera -a 'useradd user2'
$ ansible servera -a 'echo 123456 | passwd --stdin user1'
$ ansible servera -m shell -a 'echo 123456 | passwd --stdin user1'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="13-4-管理存储"><a href="#13-4-管理存储" class="headerlink" title="13.4 管理存储"></a>13.4 管理存储</h2><table>
<thead>
<tr>
<th align="left">模块名</th>
<th align="left">linux指令</th>
<th align="left">Linux实施命令</th>
</tr>
</thead>
<tbody><tr>
<td align="left">community.general.parted</td>
<td align="left">parted</td>
<td align="left">parted /dev/vdb mkpart part1 2048s 1G</td>
</tr>
<tr>
<td align="left">community.general.lvg</td>
<td align="left">vgcreate</td>
<td align="left">vgcreate -s 16M vg100 /dev/vdb{1..2}</td>
</tr>
<tr>
<td align="left">community.general.lvol</td>
<td align="left">lvcreate</td>
<td align="left">lvcreate -L 100M -n lv100 vg100</td>
</tr>
<tr>
<td align="left">community.general.filesystem</td>
<td align="left">mkfs</td>
<td align="left">mkfs.ext4 /dev/vg100/lv100</td>
</tr>
<tr>
<td align="left">ansible.posix.mount</td>
<td align="left">/etc/fstab</td>
<td align="left">echo “/dev/vg100/lv100 ext4 /mnt/data defaults 0 0” &gt; /etc/fstab</td>
</tr>
</tbody></table>
<h3 id="13-4-1-模块管理存储"><a href="#13-4-1-模块管理存储" class="headerlink" title="13.4.1 模块管理存储"></a>13.4.1 模块管理存储</h3><p>1.纯分区无lvm逻辑卷</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">1-1 分区 community.general.parted #先确保community.general集合已经安装，可通过ansibl-galaxy collection list来查看
# 创建两个分区每个500M
---
- name: parted
  hosts: node2
  tasks:
  - name: part 1 2048s-500M
    community.general.parted:
      device: /dev/vdc
      number: 1
      state: present
      part_end: 500MiB
  - name: part 2 500M-1000M
    community.general.parted:
      device: /dev/vdc
      number: 2
      state: present
      part_start: 500MiB
      part_end: 1GiB

1-2 格式化 community.general.filesystem
#两个分区都格式化为ext4文件系统，如果选择不同文件系统，可以分成两个模块。
  - name: Create a ext4
    community.general.filesystem:
      fstype: ext4
      dev: "{{ item }}" 
    loop:
      - /dev/vdc1
      - /dev/vdc2

1-3 挂载 ansible.posix.mount
#自动创建挂载点/mnt/part1,再将/dev/vdc1写入/etc/fstab文件最后一行，并挂载。
  - name: Mount DVD read-only
    ansible.posix.mount:
      path: /mnt/part1      #挂载点
      src: /dev/vdc1        #设备
      fstype: ext4            #文件系统类型
      state: mounted        #参考下面解释
      
-挂载选项解释：
# absent:     卸载并删除/etc/fstab内容  
# unmounted： 卸载不删除/etc/fstab内容
# present：   将挂在信息写入/etc/fstab，不挂载
# mounted：   将挂在信息写入/etc/fstab，并创建挂载点及挂载
# remounted： 重新挂载<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2.有lvm逻辑卷</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">2.分区-lvm（pv,vg,lv）-格式化-挂载
2-1 分区 community.general.parted 
#分两个区每个大约500M，/dev/vdb
---
- name: lv
  hosts: node2
  tasks:
  - name: part 1 2048s-500M
    community.general.parted:
      device: /dev/vdb
      number: 1
      state: present
      part_end: 500MiB
  - name: part 2 500M-1000M
    community.general.parted:
      device: /dev/vdb
      number: 2
      state: present
      part_start: 500MiB

2-2 pv+vg community.general.vg
#两个分区都加入vg，名称vg100
#ansible-navigator collections -m stdout | grep vg$ 查看帮助
  - name: Create a volume group vg100
    community.general.lvg:
      vg: vg100
      pvs: /dev/vdb1,/dev/vdb2
      pesize: 32

2-3 lv community.general.lvol
#创建一个lv名为lv100，大小800M
  - name: Create a logical volume lv100 size 800M
    community.general.lvol:
      vg: vg100
      lv: lv100
      size: 800
2-4 格式化 community.general.filesystem
#格式化为xfs文件系统
 - name: Create a xfs
    community.general.filesystem:
      fstype: xfs
      dev: /dev/vg100/lv100
2-5 挂载 ansible.posix.mount
#lv挂载到/mnt/data，并设置为开机自启动。
  - name: /mnt/data
    ansible.posix.mount:
      path: /mnt/data
      src: /dev/vg100/lv100
      fstype: xfs
      state: mounted
            
#整体配置
---
- name: lv
  hosts: node2
  tasks:
  - name: part 1 2048s-500M
    community.general.parted:
      device: /dev/vdb
      number: 1
      state: present
      part_end: 500MiB
  - name: part 2 500M-1000M
    community.general.parted:
      device: /dev/vdb
      number: 2
      state: present
      part_start: 500MiB
  - name: Create a volume group vg100
    community.general.lvg:
      vg: vg100
      pvs: /dev/vdb1,/dev/vdb2
      pesize: 32
  - name: Create a logical volume lv100 size 800M
    community.general.lvol:
      vg: vg100
      lv: lv100
      size: 800
  - name: Create a xfs
    community.general.filesystem:
      fstype: xfs
      dev: /dev/vg100/lv100
  - name: /mnt/data
    ansible.posix.mount:
      path: /mnt/data
      src: /dev/vg100/lv100
      fstype: xfs
      state: mounted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="13-4-2-系统角色管理存储"><a href="#13-4-2-系统角色管理存储" class="headerlink" title="13.4.2 系统角色管理存储"></a>13.4.2 系统角色管理存储</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 逻辑卷角色
[greg@control ansible]$ sudo find ./mycollection/ -name '*.yml' | grep storage|grep test.yml
./mycollection/ansible_collections/redhat/rhel_system_roles/tests/storage/test.yml
[greg@control ansible]$ cp ./mycollection/ansible_collections/redhat/rhel_system_roles/tests/storage/test.yml ./storage.yml
[greg@control ansible]$ vim disk.yml
$ vim storage.yml
---
- hosts: node4
  vars:
    storage_use_partitions: true

  roles:
    - name: redhat.rhel_system_roles.storage
      storage_pools:
        - name: vg100
          disks:
          - /dev/vdb
          volumes:
            - name: lv100
              size: 200M
              fs_type: ext4
              mount_point: '/mnt/lvm100'
              state: "present"
            - name: lv200
              size: 300M
              fs_type: xfs
              mount_point: '/mnt/lvm200'
              state: "absent"

$ ansible-navigator run storage.yml  -m stdout<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="13-5-管理网络"><a href="#13-5-管理网络" class="headerlink" title="13.5 管理网络"></a>13.5 管理网络</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">[greg@control ansible]$ sudo find ./mycollection/ -name '*.md' | grep network
[greg@control ansible]$ vim ./mycollection/ansible_collections/redhat/rhel_system_roles/roles/network/README.md
[greg@control ansible]$ sudo find ./mycollection/ -name '*.yml' | grep network 

$ vim /usr/share/doc/rhel-system-roles/collection/roles/network/README.md
$ vim playbook.yml
---
- hosts: node5
  vars:
    network_connections:
    - name: eth0
      interface_name: eth0
      type: ethernet
      state: up
      autoconnect: yes
      ip:
        address:
        - 192.0.2.3/24
        dns:
        - 192.0.2.2
        dns_search:
        - example.com
        dhcp4: no
        gateway4: 192.0.2.1
        auto6: no

  roles:
    - redhat.rhel_system_roles.network

$ ansible-navigator run playbook.yml  -m stdout<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="14-普通用户远程管理受管主机"><a href="#14-普通用户远程管理受管主机" class="headerlink" title="14 普通用户远程管理受管主机"></a>14 普通用户远程管理受管主机</h1><h2 id="14-1-超级用户远程管理方式"><a href="#14-1-超级用户远程管理方式" class="headerlink" title="14.1 超级用户远程管理方式"></a>14.1 超级用户远程管理方式</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">vim /home/greg/ansible/ansible.cfg
remote_user=root
host_key_checking = False

vim /home/greg/ansible/inventory
[all:vars]
#ansible_user=root
ansible_password=redhat<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="14-2-普通用户远程管理方式"><a href="#14-2-普通用户远程管理方式" class="headerlink" title="14.2 普通用户远程管理方式"></a>14.2 普通用户远程管理方式</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 使用greg用户远程管理受管主机
【bastion】控制节点
ansible.cfg
[defaults]
remote_user = greg
host_key_checking = False

[privilege_escalation]
become=True
become_method=sudo 
become_user=root
become_ask_pass=false

#管理节点
ssh-keygen 

ssh-copy-id greg@workstation
ssh greg@workstation

#其他受管主机上每一个主机都做如下操作
[root@workstation ~]# useradd  greg
[root@workstation ~]# echo redhat | passwd --stdin greg
[root@workstation ~]# visudo
greg    ALL=(ALL)       NOPASSWD: ALL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>














                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">罗宇</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://linuxcenter.icu/2024/04/28/zi-dong-hua-yun-wei/ansible-de-ji-ben-shi-yong/">https://linuxcenter.icu/2024/04/28/zi-dong-hua-yun-wei/ansible-de-ji-ben-shi-yong/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">罗宇</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Ansible%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/">
                                    <span class="chip bg-color">Ansible的基本使用</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/05/14/shu-ju-ku/shu-ju-ku-ji-chu/">
                    <div class="card-image">
                        
                        <img src="/img/sql.jpeg" class="responsive-img" alt="数据库基础">
                        
                        <span class="card-title">数据库基础</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            数据库指的是以一定方式储存在一起、能为多个用户共享、具有尽可能小的冗余度、与应用程序彼此独立的数据集合
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-05-14
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="post-category">
                                    数据库
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/">
                        <span class="chip bg-color">数据库基础</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/05/28/linux/linux-jin-jie/">
                    <div class="card-image">
                        
                        <img src="/img/Linux.jpeg" class="responsive-img" alt="Linux进阶">
                        
                        <span class="card-title">Linux进阶</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Linux操作系统广泛应用于服务器、桌面和嵌入式设备中，以其稳定性、安全性和高效性受到广泛欢迎‌‌，文章描述了Linux的进阶使用
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-05-28
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Linux/" class="post-category">
                                    Linux
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Linux%E8%BF%9B%E9%98%B6/">
                        <span class="chip bg-color">Linux进阶</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i
                    class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script
    src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




        <footer class="page-footer bg-color">
    
    <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="tencent"
                   type="playlist"
                   id="6402467630"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align"
        style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
            <span id="year">2021-2025</span>
            
            <span id="year">2021</span>
            <a href="/about" target="_blank">罗宇</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/"
                target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a
                href="https://github.com/blinkfox/hexo-theme-matery"
                target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">99k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span
                    id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span
                    id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            
            <!-- Baidu Analytics -->

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?7da0b91cd12d47a8bbf00c442b97ce74";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2021";
                    var startMonth = "6";
                    var startDate = "28";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
<a href="https://github.com/luovip/tecBlog.github.io" class="tooltipped" target="_blank"
    data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
    <i class="fab fa-github"></i>
</a>



<a href="mailto:luovipyu@163.com" class="tooltipped"
    target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
    <i class="fas fa-envelope-open"></i>
</a>



<a
    href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=252414302"
    class="tooltipped" target="_blank"
    data-tooltip="QQ联系我: 252414302" data-position="top"
    data-delay="50">
    <i class="fab fa-qq"></i>
</a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


        <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

        <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>

        <script
            src="/libs/materialize/materialize.min.js"></script>
        <script
            src="/libs/masonry/masonry.pkgd.min.js"></script>
        <script
            src="/libs/aos/aos.js"></script>
        <script
            src="/libs/scrollprogress/scrollProgress.min.js"></script>
        <script
            src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
        <script
            src="/js/matery.js"></script>

        <!-- Baidu Analytics -->

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?7da0b91cd12d47a8bbf00c442b97ce74";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

        <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

        
        <script
            src="/libs/others/clicklove.js"
            async="async"></script>
        
        
        <script async
            src="/libs/others/busuanzi.pure.mini.js"></script>
        

        

        

        
        
        <script type="text/javascript" color="64,224,208"
            pointColor="0,0,255"
            opacity='0.5'
            zIndex="-1"
            count="100"
            src="/libs/background/canvas-nest.js"></script>
        

        
        
        <script type="text/javascript" size="150"
            alpha='0.6'
            zIndex="-1"
            src="/libs/background/ribbon.min.js"
            async="async"></script>
        

        
        <script type="text/javascript"
            src="/libs/background/ribbon-dynamic.js"
            async="async"></script>
        

        
        <script
            src="/libs/instantpage/instantpage.js"
            type="module"></script>
        
        <!-- 冒泡 -->
        
        <script type="text/javascript">
        // 只在桌面版网页启用特效
        var windowWidth = $(window).width();
        document.write(
            '<script type="text/javascript" src="/libs/others/buble.js"><\/script>'
        );
    </script>
        
        <script type="text/javascript">
    var a_idx = 0;
jQuery(document).ready(function ($) {
    $("body").click(function (e) {
        var a = new Array("富强", "民主", "文明", "和谐", "自由", "平等", "公正", "法治", "爱国", "敬业", "诚信", "友善");
        var $i = $("<span/>").text(a[a_idx]);
        a_idx = (a_idx + 1) % a.length;
        var x = e.pageX,
            y = e.pageY;
        $i.css({
            "z-index": 5,
            "top": y - 20,
            "left": x,
            "position": "absolute",
            "font-weight": "bold",
            "color": "#FF0000"
        });
        $("body").append($i);
        $i.animate({
                "top": y - 180,
                "opacity": 0
            },
            3000,
            function () {
                $i.remove();
            });
    });
    setTimeout('delay()', 2000);
});
 
function delay() {
    $(".buryit").removeAttr("onclick");
}
 
    </script>
        <script type="text/javascript" src="/js/mouse_snow.js"></script>

        <!-- 动态标签栏 -->
        <script type="text/javascript">
      var OriginTitile = document.title, st; 
      document.addEventListener("visibilitychange", function () { 
        document.hidden ? (document.title = "爱我，别走！", clearTimeout(st)) : (document.title = "咦，你来啦！", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) }) 
    </script>

    </body>

</html>
